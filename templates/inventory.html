{% extends "base_role.html" %}

{% block title %}Inventario - Sistema POS{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header simplificado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-box-seam text-primary"></i>
                Control de Inventario
            </h1>
            <p class="text-muted mb-0">Gestión de stock en tiempo real</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="refreshInventory()">
                <i class="bi bi-arrow-clockwise"></i> Actualizar
            </button>
            <button class="btn btn-info" onclick="showUploadExcelModal()">
                <i class="bi bi-file-earmark-excel"></i> Cargar Excel
            </button>
            <button class="btn btn-success" onclick="showAddStockModal()">
                <i class="bi bi-plus-lg"></i> Agregar Stock
            </button>
            <button class="btn btn-warning" onclick="showReduceStockModal()">
                <i class="bi bi-dash-lg"></i> Reducir Stock
            </button>
        </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Productos</h6>
                            <h3 class="mb-0" id="total-products">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-box fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Stock Normal</h6>
                            <h3 class="mb-0" id="normal-stock">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-check-circle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Stock Bajo</h6>
                            <h3 class="mb-0" id="low-stock">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Sin Stock</h6>
                            <h3 class="mb-0" id="out-of-stock">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-x-circle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros y búsqueda -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Buscar productos...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="categoryFilter">
                        <option value="">Todas las categorías</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="stockFilter">
                        <option value="">Todos los estados</option>
                        <option value="normal">Stock Normal</option>
                        <option value="low">Stock Bajo</option>
                        <option value="out">Sin Stock</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="bi bi-x-lg"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Vista de inventario -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-list-ul"></i> Productos en Inventario
            </h5>
        </div>
        <div class="card-body">
            <div id="inventory-grid" class="row g-3">
                <!-- Los productos se cargarán dinámicamente aquí -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar stock -->
<div class="modal fade" id="addStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle text-success"></i> Agregar Stock
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStockForm">
                    <div class="mb-3">
                        <label for="addProduct" class="form-label">Producto *</label>
                        <select class="form-select" id="addProduct" required>
                            <option value="">Seleccionar producto...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addQuantity" class="form-label">Cantidad a agregar *</label>
                        <input type="number" class="form-control" id="addQuantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="addReason" class="form-label">Motivo *</label>
                        <select class="form-select" id="addReason" required>
                            <option value="">Seleccionar motivo...</option>
                            <option value="compra">Compra de Mercancía</option>
                            <option value="devolucion">Devolución de Cliente</option>
                            <option value="inventario">Ajuste de Inventario</option>
                            <option value="transferencia">Transferencia</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addNotes" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="addNotes" rows="2" placeholder="Notas adicionales..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="addStock()">
                    <i class="bi bi-plus-lg"></i> Agregar Stock
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para reducir stock -->
<div class="modal fade" id="reduceStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-dash-circle text-warning"></i> Reducir Stock
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reduceStockForm">
                    <div class="mb-3">
                        <label for="reduceProduct" class="form-label">Producto *</label>
                        <select class="form-select" id="reduceProduct" required>
                            <option value="">Seleccionar producto...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reduceQuantity" class="form-label">Cantidad a reducir *</label>
                        <input type="number" class="form-control" id="reduceQuantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="reduceReason" class="form-label">Motivo *</label>
                        <select class="form-select" id="reduceReason" required>
                            <option value="">Seleccionar motivo...</option>
                            <option value="venta">Venta</option>
                            <option value="merma">Merma/Pérdida</option>
                            <option value="caducidad">Caducidad</option>
                            <option value="inventario">Ajuste de Inventario</option>
                            <option value="transferencia">Transferencia</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reduceNotes" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="reduceNotes" rows="2" placeholder="Notas adicionales..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="reduceStock()">
                    <i class="bi bi-dash-lg"></i> Reducir Stock
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles del producto -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productDetailTitle">Detalles del Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productDetailContent">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer" id="productDetailActions">
                <!-- Acciones dinámicas -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver historial de movimientos -->
<div class="modal fade" id="movementHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="movementHistoryTitle">Historial de Movimientos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="movementHistoryContent">
                    <!-- Contenido dinámico -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para cargar Excel -->
<div class="modal fade" id="uploadExcelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-earmark-excel text-success"></i> Cargar Inventario desde Excel
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Instrucciones:</h6>
                    <ul class="mb-0">
                        <li>El archivo debe estar en formato Excel (.xlsx)</li>
                        <li>La primera fila debe contener los nombres de las columnas</li>
                        <li>Los campos obligatorios son: <strong>nombre, precio, categoria_id, stock_actual, precio_compra</strong></li>
                        <li>Descarga la plantilla de ejemplo para ver el formato correcto</li>
                    </ul>
                </div>
                
                <div class="mb-3">
                    <label for="excelFile" class="form-label">Seleccionar archivo Excel *</label>
                    <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" required>
                    <div class="form-text">Formatos soportados: .xlsx, .xls</div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="createMissingCategories" checked>
                        <label class="form-check-label" for="createMissingCategories">
                            Crear categorías automáticamente si no existen
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="updateExistingProducts" checked>
                        <label class="form-check-label" for="updateExistingProducts">
                            Actualizar productos existentes (por nombre)
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="createInitialStock" checked>
                        <label class="form-check-label" for="createInitialStock">
                            Crear movimiento de stock inicial
                        </label>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="downloadExcelTemplate()">
                        <i class="bi bi-download"></i> Descargar Plantilla
                    </button>
                </div>
                
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">Procesando archivo...</small>
                    </div>
                </div>
                
                <div id="uploadResults" class="mt-3" style="display: none;">
                    <!-- Resultados del procesamiento -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="uploadExcelFile()" id="uploadButton">
                    <i class="bi bi-upload"></i> Cargar Inventario
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let products = [];
let categories = [];
let currentProductId = null;

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadInventory();
    // Auto-refresh cada 60 segundos
    setInterval(loadInventory, 60000);
});

async function loadInventory() {
    try {
        const response = await fetch('/api/v1/products/');
        const data = await response.json();
        products = data.items || data;
        
        // Extraer categorías únicas
        categories = [...new Set(products.map(p => p.category_name).filter(Boolean))];
        
        populateCategoryFilter();
        updateStatistics();
        renderInventory();
    } catch (error) {
        console.error('Error cargando inventario:', error);
        showAlert('Error cargando inventario', 'error');
    }
}

function populateCategoryFilter() {
    const select = document.getElementById('categoryFilter');
    select.innerHTML = '<option value="">Todas las categorías</option>';
    
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
    });
}

function updateStatistics() {
    const total = products.length;
    const normal = products.filter(p => p.stock > p.min_stock).length;
    const low = products.filter(p => p.stock <= p.min_stock && p.stock > 0).length;
    const out = products.filter(p => p.stock === 0).length;
    
    document.getElementById('total-products').textContent = total;
    document.getElementById('normal-stock').textContent = normal;
    document.getElementById('low-stock').textContent = low;
    document.getElementById('out-of-stock').textContent = out;
}

function renderInventory() {
    const container = document.getElementById('inventory-grid');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    const stockFilter = document.getElementById('stockFilter').value;
    
    // Filtrar productos
    let filteredProducts = products.filter(product => {
        const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                            product.code?.toLowerCase().includes(searchTerm);
        const matchesCategory = !categoryFilter || product.category_name === categoryFilter;
        const matchesStock = !stockFilter || getStockStatus(product) === stockFilter;
        
        return matchesSearch && matchesCategory && matchesStock;
    });
    
    // Ordenar por estado de stock (sin stock primero, luego stock bajo)
    filteredProducts.sort((a, b) => {
        const statusA = getStockStatus(a);
        const statusB = getStockStatus(b);
        const statusOrder = { 'out': 0, 'low': 1, 'normal': 2 };
        return statusOrder[statusA] - statusOrder[statusB];
    });
    
    if (filteredProducts.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="bi bi-search fs-1 text-muted"></i>
                    <h5 class="text-muted mt-3">No se encontraron productos</h5>
                    <p class="text-muted">Intenta ajustar los filtros de búsqueda</p>
                </div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filteredProducts.map(product => `
        <div class="col-md-6 col-lg-4 col-xl-3">
            <div class="card product-card ${getStockStatusClass(product)}" onclick="viewProductDetail(${product.id})">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">${product.name}</h6>
                        <span class="badge ${getStockBadgeClass(product)}">
                            ${getStockStatusText(product)}
                        </span>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="bi bi-tag"></i> ${product.category_name || 'Sin categoría'}
                        </small>
                    </div>
                    
                    <div class="row text-center mb-2">
                        <div class="col-4">
                            <div class="border-end">
                                <h6 class="mb-0 text-primary">${product.stock}</h6>
                                <small class="text-muted">Actual</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border-end">
                                <h6 class="mb-0 text-warning">${product.min_stock || 0}</h6>
                                <small class="text-muted">Mínimo</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <h6 class="mb-0 text-success">$${product.price}</h6>
                            <small class="text-muted">Precio</small>
                        </div>
                    </div>
                    
                    ${product.stock <= (product.min_stock || 0) ? `
                        <div class="alert alert-warning py-2 mb-0">
                            <small><i class="bi bi-exclamation-triangle"></i> Stock bajo</small>
                        </div>
                    ` : ''}
                </div>
                <div class="card-footer bg-transparent">
                    <div class="btn-group btn-group-sm w-100" role="group">
                        <button class="btn btn-outline-success" onclick="quickAddStock(${product.id}); event.stopPropagation();">
                            <i class="bi bi-plus"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="quickReduceStock(${product.id}); event.stopPropagation();">
                            <i class="bi bi-dash"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="viewMovementHistory(${product.id}); event.stopPropagation();">
                            <i class="bi bi-clock-history"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function getStockStatus(product) {
    if (product.stock === 0) return 'out';
    if (product.stock <= (product.min_stock || 0)) return 'low';
    return 'normal';
}

function getStockStatusClass(product) {
    const status = getStockStatus(product);
    switch(status) {
        case 'out': return 'border-danger';
        case 'low': return 'border-warning';
        default: return 'border-success';
    }
}

function getStockBadgeClass(product) {
    const status = getStockStatus(product);
    switch(status) {
        case 'out': return 'bg-danger';
        case 'low': return 'bg-warning';
        default: return 'bg-success';
    }
}

function getStockStatusText(product) {
    const status = getStockStatus(product);
    switch(status) {
        case 'out': return 'Sin Stock';
        case 'low': return 'Stock Bajo';
        default: return 'Normal';
    }
}

function showAddStockModal() {
    const modal = new bootstrap.Modal(document.getElementById('addStockModal'));
    populateProductSelect('addProduct');
    modal.show();
}

function showReduceStockModal() {
    const modal = new bootstrap.Modal(document.getElementById('reduceStockModal'));
    populateProductSelect('reduceProduct');
    modal.show();
}

function populateProductSelect(selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">Seleccionar producto...</option>';
    
    products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.name} (Stock: ${product.stock})`;
        select.appendChild(option);
    });
}

async function addStock() {
    const productId = document.getElementById('addProduct').value;
    const quantity = document.getElementById('addQuantity').value;
    const reason = document.getElementById('addReason').value;
    const notes = document.getElementById('addNotes').value;
    
    if (!productId || !quantity || !reason) {
        showAlert('Por favor completa todos los campos requeridos', 'error');
        return;
    }
    
    const product = products.find(p => p.id == productId);
    const newStock = product.stock + parseInt(quantity);
    
    try {
        const response = await fetch('/api/v1/inventory/adjust', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                product_id: parseInt(productId),
                adjustment_type: 'add',
                quantity: parseInt(quantity),
                new_stock: newStock,
                reason: reason,
                notes: notes
            })
        });
        
        if (response.ok) {
            showAlert('Stock agregado exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addStockModal')).hide();
            document.getElementById('addStockForm').reset();
            loadInventory();
        } else {
            showAlert('Error agregando stock', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error agregando stock', 'error');
    }
}

async function reduceStock() {
    const productId = document.getElementById('reduceProduct').value;
    const quantity = document.getElementById('reduceQuantity').value;
    const reason = document.getElementById('reduceReason').value;
    const notes = document.getElementById('reduceNotes').value;
    
    if (!productId || !quantity || !reason) {
        showAlert('Por favor completa todos los campos requeridos', 'error');
        return;
    }
    
    const product = products.find(p => p.id == productId);
    const newStock = product.stock - parseInt(quantity);
    
    if (newStock < 0) {
        showAlert('No hay suficiente stock para reducir', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/v1/inventory/adjust', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                product_id: parseInt(productId),
                adjustment_type: 'subtract',
                quantity: parseInt(quantity),
                new_stock: newStock,
                reason: reason,
                notes: notes
            })
        });
        
        if (response.ok) {
            showAlert('Stock reducido exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('reduceStockModal')).hide();
            document.getElementById('reduceStockForm').reset();
            loadInventory();
        } else {
            showAlert('Error reduciendo stock', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error reduciendo stock', 'error');
    }
}

function quickAddStock(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    const quantity = prompt(`¿Cuántas unidades de "${product.name}" quieres agregar?`);
    if (!quantity || isNaN(quantity) || quantity <= 0) return;
    
    const reason = prompt('Motivo (compra, devolucion, inventario, otro):', 'compra');
    if (!reason) return;
    
    const newStock = product.stock + parseInt(quantity);
    
    fetch('/api/v1/inventory/adjust', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            product_id: productId,
            adjustment_type: 'add',
            quantity: parseInt(quantity),
            new_stock: newStock,
            reason: reason,
            notes: 'Ajuste rápido desde inventario'
        })
    }).then(response => {
        if (response.ok) {
            showAlert('Stock agregado exitosamente', 'success');
            loadInventory();
        } else {
            showAlert('Error agregando stock', 'error');
        }
    }).catch(error => {
        console.error('Error:', error);
        showAlert('Error agregando stock', 'error');
    });
}

function quickReduceStock(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    const quantity = prompt(`¿Cuántas unidades de "${product.name}" quieres reducir?`);
    if (!quantity || isNaN(quantity) || quantity <= 0) return;
    
    if (parseInt(quantity) > product.stock) {
        showAlert('No hay suficiente stock para reducir', 'error');
        return;
    }
    
    const reason = prompt('Motivo (venta, merma, caducidad, otro):', 'venta');
    if (!reason) return;
    
    const newStock = product.stock - parseInt(quantity);
    
    fetch('/api/v1/inventory/adjust', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            product_id: productId,
            adjustment_type: 'subtract',
            quantity: parseInt(quantity),
            new_stock: newStock,
            reason: reason,
            notes: 'Ajuste rápido desde inventario'
        })
    }).then(response => {
        if (response.ok) {
            showAlert('Stock reducido exitosamente', 'success');
            loadInventory();
        } else {
            showAlert('Error reduciendo stock', 'error');
        }
    }).catch(error => {
        console.error('Error:', error);
        showAlert('Error reduciendo stock', 'error');
    });
}

function viewProductDetail(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
    const title = document.getElementById('productDetailTitle');
    const content = document.getElementById('productDetailContent');
    const actions = document.getElementById('productDetailActions');
    
    title.textContent = product.name;
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Información del Producto</h6>
                <p><strong>Nombre:</strong> ${product.name}</p>
                <p><strong>Categoría:</strong> ${product.category_name || 'Sin categoría'}</p>
                <p><strong>Código:</strong> ${product.code || 'Sin código'}</p>
                <p><strong>Precio:</strong> $${product.price}</p>
                <p><strong>Stock Mínimo:</strong> ${product.min_stock || 0}</p>
            </div>
            <div class="col-md-6">
                <h6>Estado del Stock</h6>
                <div class="card ${getStockStatusClass(product)}">
                    <div class="card-body text-center">
                        <h2 class="mb-0">${product.stock}</h2>
                        <p class="mb-0">Unidades disponibles</p>
                        <span class="badge ${getStockBadgeClass(product)}">
                            ${getStockStatusText(product)}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        ${product.description ? `
            <div class="mt-3">
                <h6>Descripción</h6>
                <p>${product.description}</p>
            </div>
        ` : ''}
    `;
    
    actions.innerHTML = `
        <button class="btn btn-success" onclick="quickAddStock(${product.id})">
            <i class="bi bi-plus"></i> Agregar Stock
        </button>
        <button class="btn btn-warning" onclick="quickReduceStock(${product.id})">
            <i class="bi bi-dash"></i> Reducir Stock
        </button>
        <button class="btn btn-info" onclick="viewMovementHistory(${product.id})">
            <i class="bi bi-clock-history"></i> Ver Historial
        </button>
    `;
    
    modal.show();
}

async function viewMovementHistory(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    try {
        const response = await fetch(`/api/v1/inventory/movements/${productId}`);
        const movements = await response.json();
        
        const modal = new bootstrap.Modal(document.getElementById('movementHistoryModal'));
        const title = document.getElementById('movementHistoryTitle');
        const content = document.getElementById('movementHistoryContent');
        
        title.textContent = `Historial de Movimientos - ${product.name}`;
        
        if (movements.length === 0) {
            content.innerHTML = '<div class="text-center py-4">No hay movimientos registrados</div>';
        } else {
            content.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Cantidad</th>
                                <th>Stock Anterior</th>
                                <th>Stock Nuevo</th>
                                <th>Motivo</th>
                                <th>Usuario</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${movements.map(movement => `
                                <tr>
                                    <td>${formatDateTime(movement.created_at)}</td>
                                    <td>
                                        <span class="badge ${movement.adjustment_type === 'add' ? 'bg-success' : 'bg-warning'}">
                                            ${movement.adjustment_type === 'add' ? 'Entrada' : 'Salida'}
                                        </span>
                                    </td>
                                    <td>${movement.quantity}</td>
                                    <td>${movement.previous_stock}</td>
                                    <td>${movement.new_stock}</td>
                                    <td>${movement.reason}</td>
                                    <td>${movement.user?.username || 'Sistema'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        modal.show();
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error cargando historial', 'error');
    }
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('es-ES', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function refreshInventory() {
    loadInventory();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('stockFilter').value = '';
    renderInventory();
}

function showAlert(message, type) {
    // Implementar sistema de alertas
    console.log(`${type}: ${message}`);
}

// Funciones para carga de Excel
function showUploadExcelModal() {
    const modal = new bootstrap.Modal(document.getElementById('uploadExcelModal'));
    modal.show();
}

function downloadExcelTemplate() {
    // Crear datos de ejemplo para la plantilla
    const templateData = [
        {
            nombre: 'Hamburguesa Clásica',
            precio: 12.50,
            categoria_id: 1,
            stock_actual: 50,
            precio_compra: 8.00,
            descripcion: 'Hamburguesa con carne, lechuga, tomate y queso',
            codigo_barras: '1234567890123',
            sku: 'HAMB001',
            punto_reorden: 10,
            cantidad_reorden: 30,
            unidad_medida: 'unidades',
            peso: 0.3,
            dimensiones: '15x10x5 cm',
            ubicacion_default: 'Refrigerador',
            fecha_vencimiento: '2024-12-31',
            lote: 'LOT001',
            proveedor: 'Carnes Premium'
        },
        {
            nombre: 'Coca Cola 500ml',
            precio: 2.50,
            categoria_id: 2,
            stock_actual: 100,
            precio_compra: 1.80,
            descripcion: 'Refresco Coca Cola 500ml',
            codigo_barras: '1234567890124',
            sku: 'BEB001',
            punto_reorden: 20,
            cantidad_reorden: 50,
            unidad_medida: 'unidades',
            peso: 0.5,
            dimensiones: '8x8x15 cm',
            ubicacion_default: 'Refrigerador',
            fecha_vencimiento: '2025-06-30',
            lote: 'LOT002',
            proveedor: 'Coca Cola'
        }
    ];
    
    // Crear el archivo Excel usando SheetJS
    const ws = XLSX.utils.json_to_sheet(templateData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventario");
    
    // Descargar el archivo
    XLSX.writeFile(wb, "plantilla_inventario.xlsx");
}

async function uploadExcelFile() {
    const fileInput = document.getElementById('excelFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('Por favor selecciona un archivo Excel', 'error');
        return;
    }
    
    // Validar tipo de archivo
    if (!file.name.match(/\.(xlsx|xls)$/)) {
        showAlert('Por favor selecciona un archivo Excel válido (.xlsx o .xls)', 'error');
        return;
    }
    
    // Mostrar progreso
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    const resultsDiv = document.getElementById('uploadResults');
    const uploadButton = document.getElementById('uploadButton');
    
    progressDiv.style.display = 'block';
    resultsDiv.style.display = 'none';
    uploadButton.disabled = true;
    progressBar.style.width = '0%';
    
    try {
        // Leer el archivo Excel
        const data = await readExcelFile(file);
        progressBar.style.width = '30%';
        
        // Validar datos
        const validation = validateExcelData(data);
        if (!validation.isValid) {
            throw new Error(`Error de validación: ${validation.errors.join(', ')}`);
        }
        progressBar.style.width = '50%';
        
        // Preparar datos para envío
        const uploadData = {
            products: data,
            options: {
                create_missing_categories: document.getElementById('createMissingCategories').checked,
                update_existing_products: document.getElementById('updateExistingProducts').checked,
                create_initial_stock: document.getElementById('createInitialStock').checked
            }
        };
        
        progressBar.style.width = '70%';
        
        // Enviar datos al servidor
        const response = await fetch('/api/v1/inventory/upload-excel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(uploadData)
        });
        
        progressBar.style.width = '90%';
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Error al procesar el archivo');
        }
        
        const result = await response.json();
        progressBar.style.width = '100%';
        
        // Mostrar resultados
        showUploadResults(result);
        
        // Recargar inventario
        setTimeout(() => {
            loadInventory();
        }, 1000);
        
    } catch (error) {
        console.error('Error:', error);
        showAlert(`Error: ${error.message}`, 'error');
    } finally {
        uploadButton.disabled = false;
        setTimeout(() => {
            progressDiv.style.display = 'none';
        }, 2000);
    }
}

function readExcelFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // Convertir a formato de objetos
                const headers = jsonData[0];
                const rows = jsonData.slice(1);
                
                const products = rows.map(row => {
                    const product = {};
                    headers.forEach((header, index) => {
                        if (row[index] !== undefined) {
                            product[header] = row[index];
                        }
                    });
                    return product;
                });
                
                resolve(products);
            } catch (error) {
                reject(new Error('Error al leer el archivo Excel'));
            }
        };
        
        reader.onerror = () => reject(new Error('Error al leer el archivo'));
        reader.readAsArrayBuffer(file);
    });
}

function validateExcelData(data) {
    const errors = [];
    const requiredFields = ['nombre', 'precio', 'categoria_id', 'stock_actual', 'precio_compra'];
    
    if (!Array.isArray(data) || data.length === 0) {
        errors.push('El archivo no contiene datos válidos');
        return { isValid: false, errors };
    }
    
    data.forEach((row, index) => {
        const rowNumber = index + 2; // +2 porque la primera fila es el header
        
        requiredFields.forEach(field => {
            if (!row[field] && row[field] !== 0) {
                errors.push(`Fila ${rowNumber}: Campo '${field}' es obligatorio`);
            }
        });
        
        // Validar tipos de datos
        if (row.precio && isNaN(parseFloat(row.precio))) {
            errors.push(`Fila ${rowNumber}: El precio debe ser un número válido`);
        }
        
        if (row.categoria_id && isNaN(parseInt(row.categoria_id))) {
            errors.push(`Fila ${rowNumber}: El ID de categoría debe ser un número válido`);
        }
        
        if (row.stock_actual && isNaN(parseInt(row.stock_actual))) {
            errors.push(`Fila ${rowNumber}: El stock actual debe ser un número válido`);
        }
        
        if (row.precio_compra && isNaN(parseFloat(row.precio_compra))) {
            errors.push(`Fila ${rowNumber}: El precio de compra debe ser un número válido`);
        }
    });
    
    return { isValid: errors.length === 0, errors };
}

function showUploadResults(result) {
    const resultsDiv = document.getElementById('uploadResults');
    
    let html = `
        <div class="alert alert-success">
            <h6><i class="bi bi-check-circle"></i> Carga completada exitosamente</h6>
            <ul class="mb-0">
                <li><strong>Productos creados:</strong> ${result.created_count || 0}</li>
                <li><strong>Productos actualizados:</strong> ${result.updated_count || 0}</li>
                <li><strong>Categorías creadas:</strong> ${result.categories_created || 0}</li>
                <li><strong>Movimientos de stock creados:</strong> ${result.stock_movements_created || 0}</li>
            </ul>
        </div>
    `;
    
    if (result.errors && result.errors.length > 0) {
        html += `
            <div class="alert alert-warning">
                <h6><i class="bi bi-exclamation-triangle"></i> Advertencias:</h6>
                <ul class="mb-0">
                    ${result.errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
}

// Configurar listeners para filtros
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchInput').addEventListener('input', renderInventory);
    document.getElementById('categoryFilter').addEventListener('change', renderInventory);
    document.getElementById('stockFilter').addEventListener('change', renderInventory);
});
</script>

<style>
.product-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border-width: 2px;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.product-card.border-danger {
    background-color: #fff5f5;
}

.product-card.border-warning {
    background-color: #fffbf0;
}

.product-card.border-success {
    background-color: #f8fff9;
}

@media (max-width: 768px) {
    .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }
}

@media (max-width: 576px) {
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 0.25rem;
    }
}
</style>
{% endblock %}
