{% extends "base.html" %}

{% block title %}Inventario - Sistema POS{% endblock %}

{% block extra_css %}
<style>
    .inventory-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .inventory-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0;
    }
    
    .stats-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin: 0;
    }
    
    .product-card {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .product-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
    }
    
    .stock-indicator {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .stock-low {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .stock-ok {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .stock-out {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .category-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .measurement-badge {
        background-color: #e9ecef;
        color: #495057;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    
    .search-box {
        border-radius: 25px;
        border: 2px solid #e9ecef;
        padding: 12px 20px;
        transition: all 0.3s ease;
    }
    
    .search-box:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .filter-btn {
        border-radius: 20px;
        padding: 8px 16px;
        margin: 0 5px;
        transition: all 0.3s ease;
    }
    
    .filter-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 25px;
        padding: 12px 24px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0;
        border: none;
    }
    
    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 12px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .floating-label {
        position: relative;
        margin-bottom: 20px;
    }
    
    .floating-label input, .floating-label select {
        padding-top: 25px;
    }
    
    .floating-label label {
        position: absolute;
        top: 8px;
        left: 15px;
        font-size: 0.8rem;
        color: #6c757d;
        transition: all 0.3s ease;
        pointer-events: none;
    }
    
    .floating-label input:focus + label,
    .floating-label input:not(:placeholder-shown) + label,
    .floating-label select:focus + label,
    .floating-label select:not([value=""]) + label {
        top: -8px;
        left: 10px;
        font-size: 0.7rem;
        color: #667eea;
        background: white;
        padding: 0 5px;
    }
    
    /* Estilos para pestañas */
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
    }
    
    .nav-tabs .nav-link {
        border: none;
        border-radius: 10px 10px 0 0;
        margin-right: 5px;
        color: #6c757d;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: transparent;
        color: #667eea;
        background-color: rgba(102, 126, 234, 0.1);
    }
    
    .nav-tabs .nav-link.active {
        color: #667eea;
        background-color: white;
        border-color: #e9ecef #e9ecef white;
        border-bottom: 2px solid white;
        font-weight: 600;
    }
    
    /* Estilos para tabla de movimientos */
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
    }
    
    .table td {
        vertical-align: middle;
        font-size: 0.9rem;
    }
    
    .badge {
        font-size: 0.75rem;
        padding: 0.4em 0.6em;
    }
    
    /* Estilos para resumen de movimientos */
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header con estadísticas -->
    <div class="row mb-4">
        <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                        <i class="bi bi-archive text-primary"></i>
                        Gestión de Inventario
            </h1>
                    <p class="text-muted mb-0">Control de stock y materias primas</p>
        </div>
                <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#productModal">
                    <i class="bi bi-plus-circle me-2"></i>Nuevo Producto
            </button>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 class="stats-number" id="totalProducts">0</h3>
                <p class="stats-label">Total Productos</p>
                        </div>
                        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 class="stats-number" id="lowStockProducts">0</h3>
                <p class="stats-label">Stock Bajo</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 class="stats-number" id="outOfStockProducts">0</h3>
                <p class="stats-label">Sin Stock</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 class="stats-number" id="totalValue">$0</h3>
                <p class="stats-label">Valor Total</p>
                        </div>
                        </div>
                    </div>

    <!-- Pestañas de navegación -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="inventoryTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">
                        <i class="bi bi-box-seam me-2"></i>Productos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                        <i class="bi bi-clock-history me-2"></i>Histórico de Movimientos
                    </button>
                </li>
            </ul>
                </div>
            </div>

    <!-- Contenido de las pestañas -->
    <div class="tab-content" id="inventoryTabContent">
        <!-- Pestaña de Productos -->
        <div class="tab-pane fade show active" id="products" role="tabpanel">
            <!-- Filtros y búsqueda -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control search-box border-start-0" id="searchInput" 
                               placeholder="Buscar productos...">
        </div>
                        </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end">
                        <button class="btn filter-btn active" data-filter="all">Todos</button>
                        <button class="btn filter-btn" data-filter="low-stock">Stock Bajo</button>
                        <button class="btn filter-btn" data-filter="out-of-stock">Sin Stock</button>
                        <button class="btn filter-btn" data-filter="categories">Categorías</button>
                        </div>
                    </div>
                </div>

            <!-- Lista de productos -->
            <div class="row" id="productsContainer">
                <!-- Los productos se cargarán dinámicamente -->
        </div>
    </div>

        <!-- Pestaña de Histórico -->
        <div class="tab-pane fade" id="history" role="tabpanel">
            <!-- Filtros del histórico -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label class="form-label">Fecha Inicio</label>
                    <input type="date" class="form-control" id="startDate">
                    </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha Fin</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Producto</label>
                    <select class="form-select" id="historyProductFilter">
                        <option value="">Todos los productos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo de Movimiento</label>
                    <select class="form-select" id="movementTypeFilter">
                        <option value="">Todos los tipos</option>
                        <option value="entrada">Entrada</option>
                        <option value="salida">Salida</option>
                        <option value="ajuste">Ajuste</option>
                    </select>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-12">
                    <button class="btn btn-primary-custom" onclick="loadMovementHistory()">
                        <i class="bi bi-search me-2"></i>Buscar Movimientos
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="exportMovementHistory()">
                        <i class="bi bi-download me-2"></i>Exportar
                    </button>
                </div>
            </div>

            <!-- Resumen del histórico -->
            <div class="row mb-4" id="historySummary">
                <!-- El resumen se cargará dinámicamente -->
    </div>

            <!-- Tabla de movimientos -->
            <div class="row">
                <div class="col-12">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                                <i class="bi bi-list-ul me-2"></i>Movimientos de Inventario
            </h5>
        </div>
        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="movementsTable">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Producto</th>
                                            <th>Tipo</th>
                                            <th>Cantidad</th>
                                            <th>Stock Anterior</th>
                                            <th>Stock Nuevo</th>
                                            <th>Usuario</th>
                                            <th>Motivo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="movementsTableBody">
                                        <!-- Los movimientos se cargarán dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar producto -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">
                    <i class="bi bi-plus-circle me-2"></i>Nuevo Producto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="floating-label">
                                <input type="text" class="form-control" id="productName" placeholder=" " required>
                                <label for="productName">Nombre del Producto *</label>
                    </div>
                    </div>
                        <div class="col-md-6">
                            <div class="floating-label">
                                <input type="text" class="form-control" id="productCode" placeholder=" ">
                                <label for="productCode">Código del Producto</label>
                    </div>
    </div>
</div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="floating-label">
                                <select class="form-select" id="productCategory" required>
                                    <option value="">Seleccionar categoría...</option>
                        </select>
                                <label for="productCategory">Categoría *</label>
                    </div>
                    </div>
                        <div class="col-md-6">
                            <div class="floating-label">
                                <select class="form-select" id="measurementType" required>
                                    <option value="">Seleccionar medida...</option>
                                    <option value="gramos">Gramos (g)</option>
                                    <option value="kg">Kilogramos (kg)</option>
                                    <option value="litros">Litros (L)</option>
                                    <option value="ml">Mililitros (ml)</option>
                                    <option value="porciones">Porciones</option>
                                    <option value="botellas">Botellas</option>
                                    <option value="unidades">Unidades</option>
                                    <option value="paquetes">Paquetes</option>
                        </select>
                                <label for="measurementType">Tipo de Medida *</label>
                    </div>
                    </div>
            </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="floating-label">
                                <input type="number" class="form-control" id="currentStock" placeholder=" " min="0" step="0.01" required>
                                <label for="currentStock">Stock Actual *</label>
            </div>
        </div>
                        <div class="col-md-4">
                            <div class="floating-label">
                                <input type="number" class="form-control" id="minStock" placeholder=" " min="0" step="0.01" required>
                                <label for="minStock">Stock Mínimo *</label>
    </div>
</div>
                        <div class="col-md-4">
                            <div class="floating-label">
                                <input type="number" class="form-control" id="purchasePrice" placeholder=" " min="0" step="0.01">
                                <label for="purchasePrice">Precio de Compra</label>
            </div>
            </div>
            </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="floating-label">
                                <input type="text" class="form-control" id="supplier" placeholder=" ">
                                <label for="supplier">Proveedor</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="floating-label">
                                <input type="text" class="form-control" id="barcode" placeholder=" ">
                                <label for="barcode">Código de Barras</label>
        </div>
    </div>
</div>

                    <div class="floating-label">
                        <textarea class="form-control" id="productDescription" rows="3" placeholder=" "></textarea>
                        <label for="productDescription">Descripción</label>
            </div>
                </form>
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary-custom" onclick="saveProduct()">
                    <i class="bi bi-check-circle me-2"></i>Guardar Producto
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ajustar stock -->
<div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-up-down me-2"></i>Ajustar Stock
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockForm">
                    <input type="hidden" id="stockProductId">
                
                <div class="mb-3">
                        <label class="form-label">Producto</label>
                        <input type="text" class="form-control" id="stockProductName" readonly>
                </div>
                
                <div class="mb-3">
                        <label class="form-label">Stock Actual</label>
                        <input type="text" class="form-control" id="currentStockDisplay" readonly>
                </div>
                
                <div class="mb-3">
                        <label class="form-label">Tipo de Ajuste</label>
                        <select class="form-select" id="adjustmentType" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="entrada">Entrada (Agregar)</option>
                            <option value="salida">Salida (Quitar)</option>
                            <option value="ajuste">Ajuste (Corregir)</option>
                        </select>
                </div>
                
                <div class="mb-3">
                        <label class="form-label">Cantidad</label>
                        <input type="number" class="form-control" id="adjustmentQuantity" min="0" step="0.01" required>
                </div>
                
                    <div class="mb-3">
                        <label class="form-label">Motivo</label>
                        <textarea class="form-control" id="adjustmentReason" rows="2" placeholder="Ej: Compra de proveedor, Merma, Ajuste de inventario..."></textarea>
                </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary-custom" onclick="saveStockAdjustment()">
                    <i class="bi bi-check-circle me-2"></i>Aplicar Ajuste
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let products = [];
let categories = [];
let currentFilter = 'all';

// Cargar datos al inicializar
document.addEventListener('DOMContentLoaded', function() {
    loadCategories();
    loadProducts();
    setupEventListeners();
});

// Configurar event listeners
function setupEventListeners() {
    // Búsqueda
    document.getElementById('searchInput').addEventListener('input', filterProducts);
    
    // Filtros
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            filterProducts();
        });
    });
}

// Cargar categorías
async function loadCategories() {
    try {
        const token = localStorage.getItem('auth_token');
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch('/api/v1/products/categories', {
            headers: headers
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        categories = Array.isArray(data) ? data : [];
        console.log('🏷️ Categorías cargadas:', categories);
        
        const select = document.getElementById('productCategory');
        select.innerHTML = '<option value="">Seleccionar categoría...</option>';
        
        categories.forEach(category => {
            const option = new Option(category.name, category.id);
            select.add(option);
        });
        
        console.log(`🏷️ ${categories.length} categorías agregadas al select`);
    } catch (error) {
        console.error('Error cargando categorías:', error);
        categories = [];
        showAlert('Error cargando categorías: ' + error.message, 'danger');
    }
}

// Cargar productos
async function loadProducts() {
    try {
        const token = localStorage.getItem('auth_token');
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch('/api/v1/products/inventory?skip=0&limit=1000', {
            headers: headers
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('📦 Datos recibidos del endpoint:', data);
        
        // El endpoint devuelve {success: true, count: 21, products: [...]}
        if (data.success && data.products) {
            products = Array.isArray(data.products) ? data.products : [];
        } else if (Array.isArray(data)) {
            // Fallback para formato de array directo
            products = data;
        } else {
            products = [];
        }
        
        console.log('📦 Productos procesados:', products);
        renderProducts();
        updateStatistics();
    } catch (error) {
        console.error('Error cargando productos:', error);
        products = [];
        renderProducts();
        showAlert('Error cargando productos: ' + error.message, 'danger');
    }
}

// Renderizar productos
function renderProducts() {
    console.log('🎨 Renderizando productos:', products);
    const container = document.getElementById('productsContainer');
    container.innerHTML = '';
    
    if (products.length === 0) {
        console.log('⚠️ No hay productos para renderizar');
        container.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">No hay productos</h4>
                    <p class="text-muted">Comienza agregando tu primer producto al inventario</p>
                    <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#productModal">
                        <i class="bi bi-plus-circle me-2"></i>Agregar Producto
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    console.log(`✅ Renderizando ${products.length} productos`);
    
    products.forEach(product => {
        const productCard = createProductCard(product);
        container.appendChild(productCard);
    });
}

// Crear tarjeta de producto
function createProductCard(product) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4';
    
    const stockStatus = getStockStatus(product);
    const category = categories.find(c => c.id === product.category_id);
    
    col.innerHTML = `
        <div class="product-card">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="flex-grow-1">
                    <h6 class="mb-1 fw-bold">${product.name}</h6>
                    <p class="text-muted mb-1 small">${product.code || 'Sin código'}</p>
                    ${category ? `<span class="category-badge">${category.name}</span>` : ''}
                            </div>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="editProduct(${product.id})">
                            <i class="bi bi-pencil me-2"></i>Editar
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="adjustStock(${product.id})">
                            <i class="bi bi-arrow-up-down me-2"></i>Ajustar Stock
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteProduct(${product.id})">
                            <i class="bi bi-trash me-2"></i>Eliminar
                        </a></li>
                    </ul>
                        </div>
                            </div>
            
            <div class="row mb-3">
                <div class="col-6">
                    <div class="text-center">
                        <h5 class="mb-0 text-primary">${product.stock_quantity || 0}</h5>
                        <small class="text-muted">Stock Actual</small>
                        </div>
                        </div>
                <div class="col-6">
                    <div class="text-center">
                        <h5 class="mb-0 text-warning">${product.min_stock_level || 0}</h5>
                        <small class="text-muted">Stock Mínimo</small>
                    </div>
                        </div>
                </div>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="stock-indicator ${stockStatus.class}">${stockStatus.text}</span>
                    <br>
                    <small class="text-muted">
                        <span class="measurement-badge">${product.unit || 'unidad'}</span>
                    </small>
                    </div>
                <div class="text-end">
                    ${product.purchase_price ? `<small class="text-success fw-bold">$${product.purchase_price}</small>` : ''}
                </div>
            </div>
        </div>
    `;
    
    return col;
}

// Obtener estado del stock
function getStockStatus(product) {
    const stock = product.stock_quantity || 0;
    const minStock = product.min_stock_level || 0;
    
    if (stock === 0) {
        return { class: 'stock-out', text: 'Sin Stock' };
    } else if (stock <= minStock) {
        return { class: 'stock-low', text: 'Stock Bajo' };
    } else {
        return { class: 'stock-ok', text: 'En Stock' };
    }
}

// Filtrar productos
function filterProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const filteredProducts = products.filter(product => {
        const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                            (product.code && product.code.toLowerCase().includes(searchTerm));
        
        if (currentFilter === 'all') return matchesSearch;
        if (currentFilter === 'low-stock') return matchesSearch && getStockStatus(product).class === 'stock-low';
        if (currentFilter === 'out-of-stock') return matchesSearch && getStockStatus(product).class === 'stock-out';
        
        return matchesSearch;
    });
    
    renderFilteredProducts(filteredProducts);
}

// Renderizar productos filtrados
function renderFilteredProducts(filteredProducts) {
    const container = document.getElementById('productsContainer');
    container.innerHTML = '';
    
    if (filteredProducts.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="bi bi-search display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">No se encontraron productos</h4>
                    <p class="text-muted">Intenta con otros términos de búsqueda</p>
                </div>
            </div>
        `;
        return;
    }
    
    filteredProducts.forEach(product => {
        const productCard = createProductCard(product);
        container.appendChild(productCard);
    });
}

// Actualizar estadísticas
function updateStatistics() {
    const total = products.length;
    const lowStock = products.filter(p => getStockStatus(p).class === 'stock-low').length;
    const outOfStock = products.filter(p => getStockStatus(p).class === 'stock-out').length;
    const totalValue = products.reduce((sum, p) => sum + ((p.purchase_price || 0) * (p.stock_quantity || 0)), 0);
    
    document.getElementById('totalProducts').textContent = total;
    document.getElementById('lowStockProducts').textContent = lowStock;
    document.getElementById('outOfStockProducts').textContent = outOfStock;
    document.getElementById('totalValue').textContent = `$${totalValue.toLocaleString()}`;
}

// Guardar producto
async function saveProduct() {
    const form = document.getElementById('productForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const categoryId = document.getElementById('productCategory').value;
    console.log('🏷️ Categoría seleccionada:', categoryId);
    if (!categoryId) {
        showAlert('Por favor selecciona una categoría', 'warning');
        return;
    }
    
    const productData = {
        name: document.getElementById('productName').value,
        code: document.getElementById('productCode').value,
        category_id: parseInt(categoryId),
        unit: document.getElementById('measurementType').value,
        stock_quantity: parseFloat(document.getElementById('currentStock').value),
        min_stock_level: parseFloat(document.getElementById('minStock').value),
        purchase_price: parseFloat(document.getElementById('purchasePrice').value) || null,
        description: document.getElementById('productDescription').value,
        product_type: 'inventory',
        is_active: true,
        price: 0,  // Agregar precio requerido
        cost_price: 0,  // Agregar costo requerido
        stock: parseFloat(document.getElementById('currentStock').value),  // Mapear stock
        min_stock: parseFloat(document.getElementById('minStock').value),  // Mapear min_stock
        max_stock: 1000  // Valor por defecto
    };
    
    console.log('🔍 Datos del producto a enviar:', productData);
    
    try {
        const productId = document.getElementById('productId').value;
        const url = productId ? `/api/v1/products/${productId}` : '/api/v1/products/debug';
        const method = productId ? 'PUT' : 'POST';
        
        // Obtener token de autenticación
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesión expirada. Por favor, inicia sesión nuevamente.', 'warning');
            window.location.href = '/login';
            return;
        }

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(productData)
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('✅ Respuesta del servidor:', result);
            showAlert('Producto guardado exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
            form.reset();
            loadProducts();
        } else {
            console.error('❌ Error HTTP:', response.status, response.statusText);
            const responseText = await response.text();
            console.error('❌ Respuesta del servidor (texto):', responseText);
            
            try {
                const error = JSON.parse(responseText);
                showAlert(`Error: ${error.detail || error.error || 'Error desconocido'}`, 'danger');
            } catch (e) {
                showAlert(`Error del servidor: ${response.status} - ${response.statusText}`, 'danger');
            }
        }
    } catch (error) {
        console.error('Error guardando producto:', error);
        showAlert('Error guardando producto', 'danger');
    }
}

// Editar producto
async function editProduct(productId) {
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesión expirada. Por favor, inicia sesión nuevamente.', 'warning');
            window.location.href = '/login';
        return;
    }
    
        const response = await fetch(`/api/v1/products/${productId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const product = await response.json();
        
        document.getElementById('productModalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Producto';
        document.getElementById('productId').value = product.id;
        document.getElementById('productName').value = product.name;
        document.getElementById('productCode').value = product.code || '';
        document.getElementById('productCategory').value = product.category_id || '';
        document.getElementById('measurementType').value = product.unit || '';
        document.getElementById('currentStock').value = product.stock_quantity || 0;
        document.getElementById('minStock').value = product.min_stock_level || 0;
        document.getElementById('purchasePrice').value = product.purchase_price || '';
        document.getElementById('productDescription').value = product.description || '';
        
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
    } catch (error) {
        console.error('Error cargando producto:', error);
        showAlert('Error cargando producto', 'danger');
    }
}

// Ajustar stock
async function adjustStock(productId) {
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesión expirada. Por favor, inicia sesión nuevamente.', 'warning');
            window.location.href = '/login';
        return;
    }
    
        const response = await fetch(`/api/v1/products/${productId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const product = await response.json();
        
        document.getElementById('stockProductId').value = product.id;
        document.getElementById('stockProductName').value = product.name;
        document.getElementById('currentStockDisplay').value = `${product.stock_quantity || 0} ${product.unit || 'unidad'}`;
        
        const modal = new bootstrap.Modal(document.getElementById('stockModal'));
    modal.show();
    } catch (error) {
        console.error('Error cargando producto:', error);
        showAlert('Error cargando producto', 'danger');
    }
}

// Guardar ajuste de stock
async function saveStockAdjustment() {
    const form = document.getElementById('stockForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const adjustmentData = {
        product_id: parseInt(document.getElementById('stockProductId').value),
        adjustment_type: document.getElementById('adjustmentType').value,
        quantity: parseFloat(document.getElementById('adjustmentQuantity').value),
        reason: document.getElementById('adjustmentReason').value
    };
    
    console.log('📊 Datos de ajuste de stock:', adjustmentData);
    
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesión expirada. Por favor, inicia sesión nuevamente.', 'warning');
            window.location.href = '/login';
            return;
        }

        const response = await fetch('/api/v1/products/inventory/adjust', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(adjustmentData)
        });
        
        if (response.ok) {
            showAlert('Stock ajustado exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('stockModal')).hide();
            form.reset();
            loadProducts();
        } else {
            const error = await response.json();
            showAlert(`Error: ${error.detail}`, 'danger');
        }
    } catch (error) {
        console.error('Error ajustando stock:', error);
        showAlert('Error ajustando stock', 'danger');
    }
}

// Eliminar producto
async function deleteProduct(productId) {
    if (!confirm('¿Estás seguro de que quieres eliminar este producto?')) {
        return;
    }
    
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesión expirada. Por favor, inicia sesión nuevamente.', 'warning');
            window.location.href = '/login';
            return;
        }

        const response = await fetch(`/api/v1/products/${productId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            showAlert('Producto eliminado exitosamente', 'success');
            loadProducts();
        } else {
            const error = await response.json();
            showAlert(`Error: ${error.detail}`, 'danger');
        }
    } catch (error) {
        console.error('Error eliminando producto:', error);
        showAlert('Error eliminando producto', 'danger');
    }
}

// Mostrar alertas
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Limpiar formulario al cerrar modal
document.getElementById('productModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('productModalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nuevo Producto';
});

// ==================== FUNCIONES DEL HISTÓRICO DE MOVIMIENTOS ====================

let movements = [];
let movementSummary = {};

// Cargar histórico de movimientos
async function loadMovementHistory() {
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesión expirada. Por favor, inicia sesión nuevamente.', 'warning');
            window.location.href = '/login';
            return;
        }

        // Obtener filtros
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const productId = document.getElementById('historyProductFilter').value;
        const movementType = document.getElementById('movementTypeFilter').value;

        // Construir URL con parámetros
        let url = '/api/v1/products/inventory/movements?skip=0&limit=1000';
        if (startDate) url += `&start_date=${startDate}`;
        if (endDate) url += `&end_date=${endDate}`;
        if (productId) url += `&product_id=${productId}`;
        if (movementType) url += `&movement_type=${movementType}`;

        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        movements = await response.json();
        console.log('📊 Movimientos cargados:', movements);
        
        renderMovements();
        loadMovementSummary();
        
    } catch (error) {
        console.error('Error cargando movimientos:', error);
        showAlert('Error cargando movimientos: ' + error.message, 'danger');
    }
}

// Cargar resumen de movimientos
async function loadMovementSummary() {
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) return;

        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        let url = '/api/v1/products/inventory/movements/summary';
        if (startDate) url += `?start_date=${startDate}`;
        if (endDate) url += `${startDate ? '&' : '?'}end_date=${endDate}`;

        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        movementSummary = data;
        console.log('📈 Resumen de movimientos:', movementSummary);
        
        renderMovementSummary();
        
    } catch (error) {
        console.error('Error cargando resumen:', error);
    }
}

// Renderizar movimientos en la tabla
function renderMovements() {
    const tbody = document.getElementById('movementsTableBody');
    tbody.innerHTML = '';

    if (movements.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="text-muted mt-2">No se encontraron movimientos</p>
                </td>
            </tr>
        `;
        return;
    }

    movements.forEach(movement => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${formatDateTime(movement.created_at)}</td>
            <td>
                <div>
                    <strong>${movement.product_name}</strong>
                    <br>
                    <small class="text-muted">${movement.product_code}</small>
                </div>
            </td>
            <td>
                <span class="badge ${getMovementTypeBadgeClass(movement.movement_type)}">
                    ${getMovementTypeLabel(movement.movement_type)}
                </span>
            </td>
            <td class="text-center">
                <strong class="${getMovementQuantityClass(movement.movement_type)}">
                    ${movement.movement_type === 'salida' ? '-' : '+'}${movement.quantity}
                </strong>
            </td>
            <td class="text-center">${movement.previous_stock}</td>
            <td class="text-center">
                <strong class="text-primary">${movement.new_stock}</strong>
            </td>
            <td>${movement.user_name}</td>
            <td>
                <small class="text-muted">${movement.notes || movement.reason || 'Sin motivo'}</small>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Renderizar resumen de movimientos
function renderMovementSummary() {
    const container = document.getElementById('historySummary');
    
    if (!movementSummary.summary || movementSummary.summary.length === 0) {
        container.innerHTML = '';
        return;
    }

    let summaryHtml = '<div class="row">';
    
    // Resumen por día
    movementSummary.summary.slice(0, 7).forEach(day => {
        const date = new Date(day.date);
        const dateStr = date.toLocaleDateString('es-ES', { 
            weekday: 'short', 
            day: 'numeric', 
            month: 'short' 
        });
        
        summaryHtml += `
            <div class="col-md-3 col-lg-2 mb-3">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <h6 class="card-title text-muted mb-2">${dateStr}</h6>
                        <h4 class="text-primary mb-1">${day.total_movements}</h4>
                        <small class="text-muted">movimientos</small>
                        <div class="mt-2">
                            ${Object.entries(day.movements).map(([type, data]) => `
                                <span class="badge ${getMovementTypeBadgeClass(type)} me-1">
                                    ${getMovementTypeLabel(type)}: ${data.count}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    summaryHtml += '</div>';
    container.innerHTML = summaryHtml;
}

// Obtener clase CSS para el tipo de movimiento
function getMovementTypeBadgeClass(type) {
    switch (type) {
        case 'entrada': return 'bg-success';
        case 'salida': return 'bg-danger';
        case 'ajuste': return 'bg-warning text-dark';
        default: return 'bg-secondary';
    }
}

// Obtener etiqueta para el tipo de movimiento
function getMovementTypeLabel(type) {
    switch (type) {
        case 'entrada': return 'Entrada';
        case 'salida': return 'Salida';
        case 'ajuste': return 'Ajuste';
        default: return type;
    }
}

// Obtener clase CSS para la cantidad
function getMovementQuantityClass(type) {
    switch (type) {
        case 'entrada': return 'text-success';
        case 'salida': return 'text-danger';
        case 'ajuste': return 'text-warning';
        default: return 'text-muted';
    }
}

// Formatear fecha y hora
function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Exportar histórico de movimientos
function exportMovementHistory() {
    if (movements.length === 0) {
        showAlert('No hay movimientos para exportar', 'warning');
        return;
    }

    // Crear CSV
    let csv = 'Fecha,Producto,Código,Tipo,Cantidad,Stock Anterior,Stock Nuevo,Usuario,Motivo\n';
    
    movements.forEach(movement => {
        csv += `"${formatDateTime(movement.created_at)}","${movement.product_name}","${movement.product_code}","${getMovementTypeLabel(movement.movement_type)}","${movement.quantity}","${movement.previous_stock}","${movement.new_stock}","${movement.user_name}","${movement.notes || movement.reason || ''}"\n`;
    });

    // Descargar archivo
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `movimientos_inventario_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('Histórico exportado exitosamente', 'success');
}

// Cargar productos en el filtro del histórico
function loadProductsForHistoryFilter() {
    const select = document.getElementById('historyProductFilter');
    select.innerHTML = '<option value="">Todos los productos</option>';
    
    products.forEach(product => {
        const option = new Option(`${product.name} (${product.code})`, product.id);
        select.add(option);
    });
}

// Configurar fechas por defecto
function setupDefaultDates() {
    const today = new Date();
    const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
}

// Event listener para cuando se cambia a la pestaña de histórico
document.getElementById('history-tab').addEventListener('click', function() {
    loadProductsForHistoryFilter();
    setupDefaultDates();
    loadMovementHistory();
});
</script>
{% endblock %}