{% extends "base.html" %}

{% block title %}Inventario - Sistema POS{% endblock %}

{% block extra_css %}
<style>
    .inventory-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .inventory-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0;
    }
    
    .stats-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin: 0;
    }
    
    .product-card {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .product-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
    }
    
    .stock-indicator {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .stock-low {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .stock-ok {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .stock-out {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .category-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .measurement-badge {
        background-color: #e9ecef;
        color: #495057;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    
    .search-box {
        border-radius: 25px;
        border: 2px solid #e9ecef;
        padding: 12px 20px;
        transition: all 0.3s ease;
    }
    
    .search-box:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .filter-btn {
        border-radius: 20px;
        padding: 8px 16px;
        margin: 0 5px;
        transition: all 0.3s ease;
    }
    
    .filter-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 25px;
        padding: 12px 24px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0;
        border: none;
    }
    
    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 12px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .floating-label {
        position: relative;
        margin-bottom: 20px;
    }
    
    .floating-label input, .floating-label select, .floating-label textarea {
        padding-top: 25px;
    }
    
    .floating-label textarea {
        min-height: 80px;
        resize: vertical;
    }
    
    .floating-label label {
        position: absolute;
        top: 8px;
        left: 15px;
        font-size: 0.8rem;
        color: #6c757d;
        transition: all 0.3s ease;
        pointer-events: none;
    }
    
    .floating-label input:focus + label,
    .floating-label input:not(:placeholder-shown) + label,
    .floating-label select:focus + label,
    .floating-label select:not([value=""]) + label,
    .floating-label textarea:focus + label,
    .floating-label textarea:not(:placeholder-shown) + label,
    .floating-label label.floating {
        top: -8px;
        left: 10px;
        font-size: 0.7rem;
        color: #667eea;
        background: white;
        padding: 0 5px;
    }
    
    /* Estilos para pesta√±as */
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
    }
    
    .nav-tabs .nav-link {
        border: none;
        border-radius: 10px 10px 0 0;
        margin-right: 5px;
        color: #6c757d;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: transparent;
        color: #667eea;
        background-color: rgba(102, 126, 234, 0.1);
    }
    
    .nav-tabs .nav-link.active {
        color: #667eea;
        background-color: white;
        border-color: #e9ecef #e9ecef white;
        border-bottom: 2px solid white;
        font-weight: 600;
    }
    
    /* Estilos para tabla de movimientos */
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
    }
    
    .table td {
        vertical-align: middle;
        font-size: 0.9rem;
    }
    
    .badge {
        font-size: 0.75rem;
        padding: 0.4em 0.6em;
    }
    
    /* Estilos para resumen de movimientos */
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    /* Estilos para tabla de productos */
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        white-space: nowrap;
    }
    
    .table td {
        vertical-align: middle;
        font-size: 0.9rem;
    }
    
    .table tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.05);
    }
    
    .btn-group .btn {
        border-radius: 0;
    }
    
    .btn-group .btn:first-child {
        border-top-left-radius: 0.375rem;
        border-bottom-left-radius: 0.375rem;
    }
    
    .btn-group .btn:last-child {
        border-top-right-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }
    
    /* Estilos para badges en tabla */
    .badge {
        font-size: 0.75rem;
        padding: 0.4em 0.6em;
    }
    
    /* Responsive para tabla */
    @media (max-width: 768px) {
        .table-responsive {
            font-size: 0.8rem;
        }
        
        .btn-group .btn {
            padding: 0.25rem 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header con estad√≠sticas -->
    <div class="row mb-4">
        <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                        <i class="bi bi-archive text-primary"></i>
                        Gesti√≥n de Inventario
            </h1>
                    <p class="text-muted mb-0">Control de stock y materias primas</p>
        </div>
                <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#productModal">
                    <i class="bi bi-plus-circle me-2"></i>Nuevo Producto
            </button>
            </div>
        </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 class="stats-number" id="totalProducts">0</h3>
                <p class="stats-label">Total Productos</p>
                        </div>
                        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 class="stats-number" id="lowStockProducts">0</h3>
                <p class="stats-label">Stock Bajo</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 class="stats-number" id="outOfStockProducts">0</h3>
                <p class="stats-label">Sin Stock</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 class="stats-number" id="totalValue">$0</h3>
                <p class="stats-label">Valor Total</p>
                        </div>
                        </div>
                    </div>

    <!-- Pesta√±as de navegaci√≥n -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="inventoryTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#table" type="button" role="tab">
                        <i class="bi bi-table me-2"></i>Productos
            </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">
                        <i class="bi bi-tags me-2"></i>Categor√≠as
            </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                        <i class="bi bi-clock-history me-2"></i>Hist√≥rico de Movimientos
            </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Contenido de las pesta√±as -->
    <div class="tab-content" id="inventoryTabContent">
        <!-- Pesta√±a de Productos (Tabla) -->
        <div class="tab-pane fade show active" id="table" role="tabpanel">
            <!-- Filtros y b√∫squeda para tabla -->
    <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control search-box border-start-0" id="tableSearchInput" 
                               placeholder="Buscar productos...">
                        </div>
                        </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end">
                        <button class="btn filter-btn active" data-filter="all" onclick="filterTableProducts('all')">Todos</button>
                        <button class="btn filter-btn" data-filter="low-stock" onclick="filterTableProducts('low-stock')">Stock Bajo</button>
                        <button class="btn filter-btn" data-filter="out-of-stock" onclick="filterTableProducts('out-of-stock')">Sin Stock</button>
                        <button class="btn btn-outline-primary ms-2" onclick="exportTableToCSV()">
                            <i class="bi bi-download me-2"></i>Exportar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabla de productos -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-table me-2"></i>Productos de Inventario
                            </h5>
        </div>
                <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="productsTable">
                                    <thead>
                                        <tr>
                                            <th>C√≥digo</th>
                                            <th>Nombre</th>
                                            <th>Categor√≠a</th>
                                            <th>Stock Actual</th>
                                            <th>Stock M√≠nimo</th>
                                            <th>Unidad</th>
                                            <th>Precio Compra</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsTableBody">
                                        <!-- Los productos se cargar√°n din√°micamente -->
                                    </tbody>
                                </table>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pesta√±a de Categor√≠as -->
        <div class="tab-pane fade" id="categories" role="tabpanel">
            <!-- Header de categor√≠as -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="bi bi-tags text-primary me-2"></i>Gesti√≥n de Categor√≠as
                    </h5>
                    <p class="text-muted mb-0">Organiza tus productos por categor√≠as</p>
                        </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#categoryModal">
                            <i class="bi bi-plus-circle me-2"></i>Nueva Categor√≠a
                        </button>
                        </div>
                    </div>
                </div>

            <!-- Estad√≠sticas de categor√≠as -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-primary mb-1" id="totalCategories">0</h3>
                            <p class="text-muted mb-0">Total Categor√≠as</p>
            </div>
        </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                <div class="card-body">
                            <h3 class="text-success mb-1" id="activeCategories">0</h3>
                            <p class="text-muted mb-0">Categor√≠as Activas</p>
                        </div>
                        </div>
                    </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-warning mb-1" id="categoriesWithProducts">0</h3>
                            <p class="text-muted mb-0">Con Productos</p>
                </div>
            </div>
        </div>
    </div>

            <!-- Tabla de categor√≠as -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-list-ul me-2"></i>Lista de Categor√≠as
                            </h5>
                        </div>
        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="categoriesTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nombre</th>
                                            <th>Descripci√≥n</th>
                                            <th>Productos</th>
                                            <th>Estado</th>
                                            <th>Fecha Creaci√≥n</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="categoriesTableBody">
                                        <!-- Las categor√≠as se cargar√°n din√°micamente -->
                                    </tbody>
                                </table>
                    </div>
                </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pesta√±a de Hist√≥rico -->
        <div class="tab-pane fade" id="history" role="tabpanel">
            <!-- Filtros del hist√≥rico -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label class="form-label">Fecha Inicio</label>
                    <input type="date" class="form-control" id="startDate">
                    </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha Fin</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Producto</label>
                    <select class="form-select" id="historyProductFilter">
                        <option value="">Todos los productos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo de Movimiento</label>
                    <select class="form-select" id="movementTypeFilter">
                        <option value="">Todos los tipos</option>
                        <option value="entrada">Entrada</option>
                        <option value="salida">Salida</option>
                        <option value="ajuste">Ajuste</option>
                    </select>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-12">
                    <button class="btn btn-primary-custom" onclick="loadMovementHistory()">
                        <i class="bi bi-search me-2"></i>Buscar Movimientos
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="exportMovementHistory()">
                        <i class="bi bi-download me-2"></i>Exportar
                    </button>
                </div>
            </div>

            <!-- Resumen del hist√≥rico -->
            <div class="row mb-4" id="historySummary">
                <!-- El resumen se cargar√° din√°micamente -->
    </div>

            <!-- Tabla de movimientos -->
            <div class="row">
                <div class="col-12">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                                <i class="bi bi-list-ul me-2"></i>Movimientos de Inventario
            </h5>
        </div>
        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="movementsTable">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Producto</th>
                                            <th>Tipo</th>
                                            <th>Cantidad</th>
                                            <th>Stock Anterior</th>
                                            <th>Stock Nuevo</th>
                                            <th>Usuario</th>
                                            <th>Motivo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="movementsTableBody">
                                        <!-- Los movimientos se cargar√°n din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar producto -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">
                    <i class="bi bi-plus-circle me-2"></i>Nuevo Producto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="floating-label">
                                <input type="text" class="form-control" id="productName" placeholder=" " required>
                                <label for="productName">Nombre del Producto *</label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="floating-label">
                                <select class="form-select" id="productCategory" required>
                                    <option value="">Seleccionar categor√≠a...</option>
                        </select>
                                <label for="productCategory">Categor√≠a *</label>
                    </div>
                    </div>
                        <div class="col-md-6">
                            <div class="floating-label">
                                <select class="form-select" id="measurementType" required>
                                    <option value="">Seleccionar medida...</option>
                                    <option value="gramos">Gramos (g)</option>
                                    <option value="kg">Kilogramos (kg)</option>
                                    <option value="litros">Litros (L)</option>
                                    <option value="ml">Mililitros (ml)</option>
                                    <option value="porciones">Porciones</option>
                                    <option value="botellas">Botellas</option>
                                    <option value="unidades">Unidades</option>
                                    <option value="paquetes">Paquetes</option>
                        </select>
                                <label for="measurementType">Tipo de Medida *</label>
                    </div>
                    </div>
            </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="floating-label">
                                <input type="number" class="form-control" id="currentStock" placeholder=" " min="0" step="0.01" required>
                                <label for="currentStock">Stock Actual *</label>
            </div>
        </div>
                        <div class="col-md-4">
                            <div class="floating-label">
                                <input type="number" class="form-control" id="minStock" placeholder=" " min="0" step="0.01" required>
                                <label for="minStock">Stock M√≠nimo *</label>
    </div>
</div>
                        <div class="col-md-4">
                            <div class="floating-label">
                                <input type="number" class="form-control" id="purchasePrice" placeholder=" " min="0" step="0.01">
                                <label for="purchasePrice">Precio de Compra</label>
            </div>
            </div>
            </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="floating-label">
                                <input type="text" class="form-control" id="supplier" placeholder=" ">
                                <label for="supplier">Proveedor</label>
                            </div>
                        </div>
                    </div>

                    <div class="floating-label">
                        <textarea class="form-control" id="productDescription" rows="3" placeholder=" "></textarea>
                        <label for="productDescription">Descripci√≥n</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary-custom" onclick="saveProduct()">
                    <i class="bi bi-check-circle me-2"></i>Guardar Producto
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ajustar stock -->
<div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-sliders me-2"></i>Ajustar Stock
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockForm">
                    <input type="hidden" id="stockProductId">
                
                    <div class="mb-3">
                        <label class="form-label">Producto</label>
                        <input type="text" class="form-control" id="stockProductName" readonly>
                    </div>
                
                    <div class="mb-3">
                        <label class="form-label">Stock Actual</label>
                        <input type="text" class="form-control" id="currentStockDisplay" readonly>
                    </div>
                
                    <div class="mb-3">
                        <label class="form-label">Tipo de Ajuste</label>
                        <select class="form-select" id="adjustmentType" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="entrada">Entrada (Agregar)</option>
                            <option value="salida">Salida (Quitar)</option>
                            <option value="ajuste">Ajuste (Corregir)</option>
                        </select>
                    </div>
                
                    <div class="mb-3">
                        <label class="form-label">Cantidad</label>
                        <input type="number" class="form-control" id="adjustmentQuantity" min="0" step="0.01" required>
                </div>
                
                    <div class="mb-3">
                        <label class="form-label">Motivo</label>
                        <textarea class="form-control" id="adjustmentReason" rows="2" placeholder="Ej: Compra de proveedor, Merma, Ajuste de inventario..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary-custom" onclick="saveStockAdjustment()">
                    <i class="bi bi-sliders me-2"></i>Aplicar Ajuste
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles del producto -->
<div class="modal fade" id="viewProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewProductModalTitle">
                    <i class="bi bi-eye me-2"></i>Detalles del Producto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">C√≥digo del Producto</label>
                            <p class="form-control-plaintext" id="viewProductCode">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nombre</label>
                            <p class="form-control-plaintext" id="viewProductName">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Categor√≠a</label>
                            <p class="form-control-plaintext" id="viewProductCategory">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tipo de Medida</label>
                            <p class="form-control-plaintext" id="viewProductUnit">-</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Stock Actual</label>
                            <p class="form-control-plaintext" id="viewProductStock">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Stock M√≠nimo</label>
                            <p class="form-control-plaintext" id="viewProductMinStock">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Precio de Compra</label>
                            <p class="form-control-plaintext" id="viewProductPurchasePrice">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Proveedor</label>
                            <p class="form-control-plaintext" id="viewProductSupplier">-</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Descripci√≥n</label>
                            <p class="form-control-plaintext" id="viewProductDescription">-</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Estado del Stock</label>
                            <p class="form-control-plaintext" id="viewProductStockStatus">-</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Fecha de Creaci√≥n</label>
                            <p class="form-control-plaintext" id="viewProductCreatedAt">-</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary-custom" onclick="editProductFromView()">
                    <i class="bi bi-pencil me-2"></i>Editar Producto
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar categor√≠a -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">
                    <i class="bi bi-plus-circle me-2"></i>Nueva Categor√≠a
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                
                <div class="mb-3">
                        <label class="form-label">Nombre de la Categor√≠a *</label>
                        <input type="text" class="form-control" id="categoryName" placeholder="Ej: Carnes, Verduras, L√°cteos..." required>
                </div>
                
                <div class="mb-3">
                        <label class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" id="categoryDescription" rows="3" placeholder="Descripci√≥n opcional de la categor√≠a..."></textarea>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="categoryActive" checked>
                            <label class="form-check-label" for="categoryActive">
                                Categor√≠a activa
                        </label>
                    </div>
                </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary-custom" onclick="saveCategory()">
                    <i class="bi bi-check-circle me-2"></i>Guardar Categor√≠a
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let products = [];
let categories = [];
let currentFilter = 'all';

// Funci√≥n para generar c√≥digo de producto autom√°ticamente
function generateProductCode(categoryId, productName) {
    // Obtener las 3 primeras letras del nombre en may√∫sculas
    const namePrefix = productName.substring(0, 3).toUpperCase();
    
    // Buscar el siguiente consecutivo para esta categor√≠a y prefijo
    const existingProducts = products.filter(p => 
        p.category_id === parseInt(categoryId) && 
        p.code && 
        p.code.startsWith(categoryId + namePrefix)
    );
    
    // Obtener el siguiente n√∫mero consecutivo
    let nextNumber = 1;
    if (existingProducts.length > 0) {
        const numbers = existingProducts.map(p => {
            const code = p.code;
            const numberPart = code.substring(categoryId.toString().length + 3);
            return parseInt(numberPart) || 0;
        });
        nextNumber = Math.max(...numbers) + 1;
    }
    
    // Formatear el n√∫mero con 2 d√≠gitos
    const formattedNumber = nextNumber.toString().padStart(2, '0');
    
    // Retornar el c√≥digo completo: ID_CATEGORIA + 3_LETRAS + 2_DIGITOS
    return `${categoryId}${namePrefix}${formattedNumber}`;
}

// Cargar datos al inicializar
document.addEventListener('DOMContentLoaded', function() {
    loadCategories();
    loadProducts();
    setupEventListeners();
    // Cargar tabla autom√°ticamente
    renderProductsTable();
});

// Configurar event listeners
function setupEventListeners() {
    // B√∫squeda en tabla
    const tableSearchInput = document.getElementById('tableSearchInput');
    if (tableSearchInput) {
        tableSearchInput.addEventListener('input', function() {
            filterTableProducts(currentTableFilter);
        });
    }
    
    // Filtros de tabla
    document.querySelectorAll('#table .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#table .filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTableFilter = this.dataset.filter;
            filterTableProducts(currentTableFilter);
        });
    });
}

// Cargar categor√≠as
async function loadCategories() {
    try {
        const token = localStorage.getItem('auth_token');
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch('/api/v1/products/categories', {
            headers: headers
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        categories = Array.isArray(data) ? data : [];
        console.log('üè∑Ô∏è Categor√≠as cargadas:', categories);
        
        const select = document.getElementById('productCategory');
        select.innerHTML = '<option value="">Seleccionar categor√≠a...</option>';
        
        categories.forEach(category => {
            const option = new Option(category.name, category.id);
            select.add(option);
        });
        
        console.log(`üè∑Ô∏è ${categories.length} categor√≠as agregadas al select`);
    } catch (error) {
        console.error('Error cargando categor√≠as:', error);
        categories = [];
        showAlert('Error cargando categor√≠as: ' + error.message, 'danger');
    }
}

// Cargar productos
async function loadProducts() {
    try {
        const token = localStorage.getItem('auth_token');
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch('/api/v1/products/inventory?skip=0&limit=1000', {
            headers: headers
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üì¶ Datos recibidos del endpoint:', data);
        
        // El endpoint devuelve {success: true, count: 21, products: [...]}
        if (data.success && data.products) {
            products = Array.isArray(data.products) ? data.products : [];
        } else if (Array.isArray(data)) {
            // Fallback para formato de array directo
            products = data;
        } else {
            products = [];
        }
        
        console.log('üì¶ Productos procesados:', products);
        renderProductsTable();
        updateStatistics();
    } catch (error) {
        console.error('Error cargando productos:', error);
        products = [];
        renderProductsTable();
        showAlert('Error cargando productos: ' + error.message, 'danger');
    }
}

// Funciones de vista de tarjetas eliminadas - solo mantenemos la vista de tabla

// Obtener estado del stock
function getStockStatus(product) {
    const stock = product.stock_quantity || 0;
    const minStock = product.min_stock_level || 0;
    
    if (stock === 0) {
        return { class: 'stock-out', text: 'Sin Stock' };
    } else if (stock <= minStock) {
        return { class: 'stock-low', text: 'Stock Bajo' };
    } else {
        return { class: 'stock-ok', text: 'En Stock' };
    }
}

// Funciones de filtrado de vista de tarjetas eliminadas

// Actualizar estad√≠sticas
function updateStatistics() {
    const total = products.length;
    const lowStock = products.filter(p => getStockStatus(p).class === 'stock-low').length;
    const outOfStock = products.filter(p => getStockStatus(p).class === 'stock-out').length;
    const totalValue = products.reduce((sum, p) => sum + ((p.purchase_price || 0) * (p.stock_quantity || 0)), 0);
    
    document.getElementById('totalProducts').textContent = total;
    document.getElementById('lowStockProducts').textContent = lowStock;
    document.getElementById('outOfStockProducts').textContent = outOfStock;
    document.getElementById('totalValue').textContent = `$${totalValue.toLocaleString()}`;
}

// Guardar producto
async function saveProduct() {
    const form = document.getElementById('productForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const categoryId = document.getElementById('productCategory').value;
    console.log('üè∑Ô∏è Categor√≠a seleccionada:', categoryId);
    if (!categoryId) {
        showAlert('Por favor selecciona una categor√≠a', 'warning');
        return;
    }
    
    // Generar c√≥digo autom√°ticamente
    const productName = document.getElementById('productName').value;
    const category = categories.find(c => c.id === parseInt(categoryId));
    const generatedCode = generateProductCode(categoryId, productName);
    
    const productData = {
        name: productName,
        code: generatedCode,
        category_id: parseInt(categoryId),
        unit: document.getElementById('measurementType').value,
        stock_quantity: parseFloat(document.getElementById('currentStock').value),
        min_stock_level: parseFloat(document.getElementById('minStock').value),
        purchase_price: parseFloat(document.getElementById('purchasePrice').value) || null,
        supplier: document.getElementById('supplier').value || null,
        description: document.getElementById('productDescription').value,
        product_type: 'inventory',
        is_active: true,
        price: 0,  // Agregar precio requerido
        cost_price: 0,  // Agregar costo requerido
        stock: parseFloat(document.getElementById('currentStock').value),  // Mapear stock
        min_stock: parseFloat(document.getElementById('minStock').value),  // Mapear min_stock
        max_stock: 1000  // Valor por defecto
    };
    
    console.log('üîç Datos del producto a enviar:', productData);
    
    try {
        const productId = document.getElementById('productId').value;
        const url = productId ? `/api/v1/products/${productId}/debug` : '/api/v1/products/debug';
        const method = productId ? 'PUT' : 'POST';
        
        // Obtener token de autenticaci√≥n
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
            window.location.href = '/login';
            return;
        }

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(productData)
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Respuesta del servidor:', result);
            showAlert('Producto guardado exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
            form.reset();
            loadProducts();
        } else {
            console.error('‚ùå Error HTTP:', response.status, response.statusText);
            const responseText = await response.text();
            console.error('‚ùå Respuesta del servidor (texto):', responseText);
            
            try {
                const error = JSON.parse(responseText);
                showAlert(`Error: ${error.detail || error.error || 'Error desconocido'}`, 'danger');
            } catch (e) {
                showAlert(`Error del servidor: ${response.status} - ${response.statusText}`, 'danger');
            }
        }
    } catch (error) {
        console.error('Error guardando producto:', error);
        showAlert('Error guardando producto', 'danger');
    }
}

// Variable global para almacenar el ID del producto en vista
let currentViewProductId = null;

// Ver detalles del producto
async function viewProduct(productId) {
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
            window.location.href = '/login';
            return;
        }
        
        const response = await fetch(`/api/v1/products/${productId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const product = await response.json();
        currentViewProductId = productId;
        
        // Llenar el modal con los datos del producto
        document.getElementById('viewProductCode').textContent = product.code || 'Sin c√≥digo';
        document.getElementById('viewProductName').textContent = product.name || '-';
        
        // Obtener nombre de la categor√≠a
        const category = categories.find(c => c.id === product.category_id);
        document.getElementById('viewProductCategory').textContent = category ? category.name : 'Sin categor√≠a';
        
        document.getElementById('viewProductUnit').textContent = product.unit || 'unidad';
        document.getElementById('viewProductStock').textContent = `${product.stock_quantity || 0} ${product.unit || 'unidad'}`;
        document.getElementById('viewProductMinStock').textContent = `${product.min_stock_level || 0} ${product.unit || 'unidad'}`;
        
        // Formatear precio de compra
        const purchasePrice = product.purchase_price ? `$${product.purchase_price.toLocaleString()}` : 'No especificado';
        document.getElementById('viewProductPurchasePrice').textContent = purchasePrice;
        
        document.getElementById('viewProductSupplier').textContent = product.supplier || 'No especificado';
        document.getElementById('viewProductDescription').textContent = product.description || 'Sin descripci√≥n';
        
        // Estado del stock
        const stockStatus = getStockStatus(product);
        document.getElementById('viewProductStockStatus').innerHTML = `<span class="stock-indicator ${stockStatus.class}">${stockStatus.text}</span>`;
        
        // Fecha de creaci√≥n
        const createdAt = product.created_at ? new Date(product.created_at).toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : 'No disponible';
        document.getElementById('viewProductCreatedAt').textContent = createdAt;
        
        const modal = new bootstrap.Modal(document.getElementById('viewProductModal'));
        modal.show();
    } catch (error) {
        console.error('Error cargando producto:', error);
        showAlert('Error cargando detalles del producto', 'danger');
    }
}

// Editar producto desde la vista
function editProductFromView() {
    if (currentViewProductId) {
        // Cerrar modal de vista
        bootstrap.Modal.getInstance(document.getElementById('viewProductModal')).hide();
        
        // Abrir modal de edici√≥n
        setTimeout(() => {
            editProduct(currentViewProductId);
        }, 300);
    }
}

// Editar producto
async function editProduct(productId) {
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
            window.location.href = '/login';
        return;
    }
    
        const response = await fetch(`/api/v1/products/${productId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const product = await response.json();
        
        document.getElementById('productModalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Producto';
        document.getElementById('productId').value = product.id;
        document.getElementById('productName').value = product.name;
        document.getElementById('productCategory').value = product.category_id || '';
        document.getElementById('measurementType').value = product.unit || '';
        document.getElementById('currentStock').value = product.stock_quantity || 0;
        document.getElementById('minStock').value = product.min_stock_level || 0;
        document.getElementById('purchasePrice').value = product.purchase_price || '';
        document.getElementById('supplier').value = product.supplier || '';
        document.getElementById('productDescription').value = product.description || '';
        
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
        
        // Manejar etiquetas flotantes despu√©s de cargar los datos
        setTimeout(() => {
            handleFloatingLabels();
        }, 100);
    } catch (error) {
        console.error('Error cargando producto:', error);
        showAlert('Error cargando producto', 'danger');
    }
}

// Ajustar stock
async function adjustStock(productId) {
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
            window.location.href = '/login';
        return;
    }
    
        const response = await fetch(`/api/v1/products/${productId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const product = await response.json();
        
        document.getElementById('stockProductId').value = product.id;
        document.getElementById('stockProductName').value = product.name;
        document.getElementById('currentStockDisplay').value = `${product.stock_quantity || 0} ${product.unit || 'unidad'}`;
        
        const modal = new bootstrap.Modal(document.getElementById('stockModal'));
    modal.show();
    } catch (error) {
        console.error('Error cargando producto:', error);
        showAlert('Error cargando producto', 'danger');
    }
}

// Guardar ajuste de stock
async function saveStockAdjustment() {
    const form = document.getElementById('stockForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const adjustmentData = {
        product_id: parseInt(document.getElementById('stockProductId').value),
        adjustment_type: document.getElementById('adjustmentType').value,
        quantity: parseFloat(document.getElementById('adjustmentQuantity').value),
        reason: document.getElementById('adjustmentReason').value
    };
    
    console.log('üìä Datos de ajuste de stock:', adjustmentData);
    
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
            window.location.href = '/login';
            return;
        }

        const response = await fetch('/api/v1/products/inventory/adjust', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(adjustmentData)
        });
        
        if (response.ok) {
            showAlert('Stock ajustado exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('stockModal')).hide();
            form.reset();
            loadProducts();
        } else {
            const error = await response.json();
            showAlert(`Error: ${error.detail}`, 'danger');
        }
    } catch (error) {
        console.error('Error ajustando stock:', error);
        showAlert('Error ajustando stock', 'danger');
    }
}

// Eliminar producto
async function deleteProduct(productId) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
        return;
    }
    
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
            window.location.href = '/login';
        return;
    }
    
        const response = await fetch(`/api/v1/products/${productId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            showAlert('Producto eliminado exitosamente', 'success');
            loadProducts();
        } else {
            const error = await response.json();
            showAlert(`Error: ${error.detail}`, 'danger');
        }
    } catch (error) {
        console.error('Error eliminando producto:', error);
        showAlert('Error eliminando producto', 'danger');
    }
}

// Mostrar alertas
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Funci√≥n para manejar etiquetas flotantes en textarea
function handleFloatingLabels() {
    const textareas = document.querySelectorAll('.floating-label textarea');
    textareas.forEach(textarea => {
        const label = textarea.nextElementSibling;
        if (label && label.tagName === 'LABEL') {
            // Verificar si el textarea tiene contenido
            if (textarea.value.trim() !== '') {
                label.classList.add('floating');
            }
            
            // Agregar event listeners
            textarea.addEventListener('input', function() {
                if (this.value.trim() !== '') {
                    label.classList.add('floating');
                } else {
                    label.classList.remove('floating');
                }
            });
            
            textarea.addEventListener('focus', function() {
                label.classList.add('floating');
            });
            
            textarea.addEventListener('blur', function() {
                if (this.value.trim() === '') {
                    label.classList.remove('floating');
                }
            });
        }
    });
}

// Limpiar formulario al cerrar modal
document.getElementById('productModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('productModalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nuevo Producto';
    
    // Resetear etiquetas flotantes
    const labels = document.querySelectorAll('.floating-label label');
    labels.forEach(label => label.classList.remove('floating'));
});

// Inicializar etiquetas flotantes cuando se abre el modal
document.getElementById('productModal').addEventListener('shown.bs.modal', function() {
    handleFloatingLabels();
});

// ==================== FUNCIONES DEL HIST√ìRICO DE MOVIMIENTOS ====================

let movements = [];
let movementSummary = {};

// Cargar hist√≥rico de movimientos
async function loadMovementHistory() {
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
            window.location.href = '/login';
        return;
    }
    
        // Obtener filtros
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const productId = document.getElementById('historyProductFilter').value;
        const movementType = document.getElementById('movementTypeFilter').value;

        // Construir URL con par√°metros
        let url = '/api/v1/products/inventory/movements?skip=0&limit=1000';
        if (startDate) url += `&start_date=${startDate}`;
        if (endDate) url += `&end_date=${endDate}`;
        if (productId) url += `&product_id=${productId}`;
        if (movementType) url += `&movement_type=${movementType}`;

        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        movements = await response.json();
        console.log('üìä Movimientos cargados:', movements);
        
        renderMovements();
        loadMovementSummary();
        
    } catch (error) {
        console.error('Error cargando movimientos:', error);
        showAlert('Error cargando movimientos: ' + error.message, 'danger');
    }
}

// Cargar resumen de movimientos
async function loadMovementSummary() {
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) return;

        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        let url = '/api/v1/products/inventory/movements/summary';
        if (startDate) url += `?start_date=${startDate}`;
        if (endDate) url += `${startDate ? '&' : '?'}end_date=${endDate}`;

        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        movementSummary = data;
        console.log('üìà Resumen de movimientos:', movementSummary);
        
        renderMovementSummary();
        
    } catch (error) {
        console.error('Error cargando resumen:', error);
    }
}

// Renderizar movimientos en la tabla
function renderMovements() {
    const tbody = document.getElementById('movementsTableBody');
    tbody.innerHTML = '';
        
        if (movements.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="text-muted mt-2">No se encontraron movimientos</p>
                </td>
                            </tr>
        `;
        return;
    }

    movements.forEach(movement => {
        const row = document.createElement('tr');
        row.innerHTML = `
                                    <td>${formatDateTime(movement.created_at)}</td>
                                    <td>
                <div>
                    <strong>${movement.product_name}</strong>
                    <br>
                    <small class="text-muted">${movement.product_code}</small>
                </div>
            </td>
            <td>
                <span class="badge ${getMovementTypeBadgeClass(movement.movement_type)}">
                    ${getMovementTypeLabel(movement.movement_type)}
                                        </span>
                                    </td>
            <td class="text-center">
                <strong class="${getMovementQuantityClass(movement.movement_type)}">
                    ${movement.movement_type === 'salida' ? '-' : '+'}${movement.quantity}
                </strong>
            </td>
            <td class="text-center">${movement.previous_stock}</td>
            <td class="text-center">
                <strong class="text-primary">${movement.new_stock}</strong>
            </td>
            <td>${movement.user_name}</td>
            <td>
                <small class="text-muted">${movement.notes || movement.reason || 'Sin motivo'}</small>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Renderizar resumen de movimientos
function renderMovementSummary() {
    const container = document.getElementById('historySummary');
    
    if (!movementSummary.summary || movementSummary.summary.length === 0) {
        container.innerHTML = '';
        return;
    }

    let summaryHtml = '<div class="row">';
    
    // Resumen por d√≠a
    movementSummary.summary.slice(0, 7).forEach(day => {
        const date = new Date(day.date);
        const dateStr = date.toLocaleDateString('es-ES', { 
            weekday: 'short', 
            day: 'numeric', 
            month: 'short' 
        });
        
        summaryHtml += `
            <div class="col-md-3 col-lg-2 mb-3">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <h6 class="card-title text-muted mb-2">${dateStr}</h6>
                        <h4 class="text-primary mb-1">${day.total_movements}</h4>
                        <small class="text-muted">movimientos</small>
                        <div class="mt-2">
                            ${Object.entries(day.movements).map(([type, data]) => `
                                <span class="badge ${getMovementTypeBadgeClass(type)} me-1">
                                    ${getMovementTypeLabel(type)}: ${data.count}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
                </div>
            `;
    });
    
    summaryHtml += '</div>';
    container.innerHTML = summaryHtml;
}

// Obtener clase CSS para el tipo de movimiento
function getMovementTypeBadgeClass(type) {
    switch (type) {
        case 'entrada': return 'bg-success';
        case 'salida': return 'bg-danger';
        case 'ajuste': return 'bg-warning text-dark';
        default: return 'bg-secondary';
    }
}

// Obtener etiqueta para el tipo de movimiento
function getMovementTypeLabel(type) {
    switch (type) {
        case 'entrada': return 'Entrada';
        case 'salida': return 'Salida';
        case 'ajuste': return 'Ajuste';
        default: return type;
    }
}

// Obtener clase CSS para la cantidad
function getMovementQuantityClass(type) {
    switch (type) {
        case 'entrada': return 'text-success';
        case 'salida': return 'text-danger';
        case 'ajuste': return 'text-warning';
        default: return 'text-muted';
    }
}

// Formatear fecha y hora
function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Exportar hist√≥rico de movimientos
function exportMovementHistory() {
    if (movements.length === 0) {
        showAlert('No hay movimientos para exportar', 'warning');
        return;
    }

    // Crear CSV
    let csv = 'Fecha,Producto,C√≥digo,Tipo,Cantidad,Stock Anterior,Stock Nuevo,Usuario,Motivo\n';
    
    movements.forEach(movement => {
        csv += `"${formatDateTime(movement.created_at)}","${movement.product_name}","${movement.product_code}","${getMovementTypeLabel(movement.movement_type)}","${movement.quantity}","${movement.previous_stock}","${movement.new_stock}","${movement.user_name}","${movement.notes || movement.reason || ''}"\n`;
    });

    // Descargar archivo
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `movimientos_inventario_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('Hist√≥rico exportado exitosamente', 'success');
}

// Cargar productos en el filtro del hist√≥rico
function loadProductsForHistoryFilter() {
    const select = document.getElementById('historyProductFilter');
    select.innerHTML = '<option value="">Todos los productos</option>';
    
    products.forEach(product => {
        const option = new Option(`${product.name} (${product.code})`, product.id);
        select.add(option);
    });
}

// Configurar fechas por defecto
function setupDefaultDates() {
    const today = new Date();
    const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
}

// Event listener para cuando se cambia a la pesta√±a de hist√≥rico
document.getElementById('history-tab').addEventListener('click', function() {
    loadProductsForHistoryFilter();
    setupDefaultDates();
    loadMovementHistory();
});

// Event listener para cuando se cambia a la pesta√±a de tabla
document.getElementById('table-tab').addEventListener('click', function() {
    renderProductsTable();
});

// Event listener para cuando se cambia a la pesta√±a de categor√≠as
document.getElementById('categories-tab').addEventListener('click', function() {
    renderCategoriesTable();
    updateCategoryStatistics();
});

// ==================== FUNCIONES DE VISTA DE TABLA ====================

let currentTableFilter = 'all';

// Renderizar productos en tabla
function renderProductsTable() {
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = '';

    if (products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="text-muted mt-2">No hay productos</p>
                </td>
            </tr>
        `;
        return;
    }
    
    products.forEach(product => {
        const row = createProductTableRow(product);
        tbody.appendChild(row);
    });
}

// Crear fila de producto para la tabla
function createProductTableRow(product) {
    const row = document.createElement('tr');
    const stockStatus = getStockStatus(product);
    const category = categories.find(c => c.id === product.category_id);
    
    row.innerHTML = `
        <td>
            <strong class="text-primary">${product.code || 'Sin c√≥digo'}</strong>
        </td>
        <td>
            <div>
                <strong>${product.name}</strong>
                ${product.description ? `<br><small class="text-muted">${product.description}</small>` : ''}
            </div>
        </td>
        <td>
            ${category ? `<span class="badge bg-secondary">${category.name}</span>` : '<span class="text-muted">Sin categor√≠a</span>'}
        </td>
        <td class="text-center">
            <strong class="text-primary">${product.stock_quantity || 0}</strong>
        </td>
        <td class="text-center">
            <span class="text-warning">${product.min_stock_level || 0}</span>
        </td>
        <td class="text-center">
            <span class="badge bg-light text-dark">${product.unit || 'unidad'}</span>
        </td>
        <td class="text-center">
            ${product.purchase_price ? `<strong class="text-success">$${product.purchase_price.toLocaleString()}</strong>` : '<span class="text-muted">-</span>'}
        </td>
        <td class="text-center">
            <span class="stock-indicator ${stockStatus.class}">${stockStatus.text}</span>
        </td>
        <td class="text-center">
            <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-info" onclick="viewProduct(${product.id})" title="Ver Detalles">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${product.id})" title="Editar">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="adjustStock(${product.id})" title="Ajustar Stock">
                    <i class="bi bi-sliders"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})" title="Eliminar">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </td>
    `;
    
    return row;
}

// Filtrar productos en la tabla
function filterTableProducts(filter) {
    currentTableFilter = filter;
    
    // Actualizar botones activos
    document.querySelectorAll('#table .filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`#table .filter-btn[data-filter="${filter}"]`).classList.add('active');
    
    // Filtrar productos
    const searchTerm = document.getElementById('tableSearchInput').value.toLowerCase();
    const filteredProducts = products.filter(product => {
        const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                            (product.code && product.code.toLowerCase().includes(searchTerm));
        
        if (filter === 'all') return matchesSearch;
        if (filter === 'low-stock') return matchesSearch && getStockStatus(product).class === 'stock-low';
        if (filter === 'out-of-stock') return matchesSearch && getStockStatus(product).class === 'stock-out';
        
        return matchesSearch;
    });
    
    renderFilteredTableProducts(filteredProducts);
}

// Renderizar productos filtrados en la tabla
function renderFilteredTableProducts(filteredProducts) {
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = '';

    if (filteredProducts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4">
                    <i class="bi bi-search display-4 text-muted"></i>
                    <p class="text-muted mt-2">No se encontraron productos</p>
                </td>
            </tr>
        `;
        return;
    }

    filteredProducts.forEach(product => {
        const row = createProductTableRow(product);
        tbody.appendChild(row);
    });
}

// Exportar tabla a CSV
function exportTableToCSV() {
    if (products.length === 0) {
        showAlert('No hay productos para exportar', 'warning');
        return;
    }

    // Crear CSV
    let csv = 'C√≥digo,Nombre,Categor√≠a,Stock Actual,Stock M√≠nimo,Unidad,Precio Compra,Estado,Descripci√≥n\n';
    
    products.forEach(product => {
        const category = categories.find(c => c.id === product.category_id);
        const stockStatus = getStockStatus(product);
        
        csv += `"${product.code || ''}","${product.name}","${category ? category.name : ''}","${product.stock_quantity || 0}","${product.min_stock_level || 0}","${product.unit || 'unidad'}","${product.purchase_price || 0}","${stockStatus.text}","${product.description || ''}"\n`;
    });

    // Descargar archivo
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `productos_inventario_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('Productos exportados exitosamente', 'success');
}

// ==================== FUNCIONES DE GESTI√ìN DE CATEGOR√çAS ====================

// Renderizar categor√≠as en tabla
function renderCategoriesTable() {
    const tbody = document.getElementById('categoriesTableBody');
    tbody.innerHTML = '';

    if (categories.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="text-muted mt-2">No hay categor√≠as</p>
                    <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#categoryModal">
                        <i class="bi bi-plus-circle me-2"></i>Crear Primera Categor√≠a
                    </button>
                </td>
            </tr>
        `;
        return;
    }

    categories.forEach(category => {
        const row = createCategoryTableRow(category);
        tbody.appendChild(row);
    });
}

// Crear fila de categor√≠a para la tabla
function createCategoryTableRow(category) {
    const row = document.createElement('tr');
    
    // Contar productos en esta categor√≠a
    const productsInCategory = products.filter(p => p.category_id === category.id).length;
    
    row.innerHTML = `
        <td>
            <strong class="text-primary">${category.id}</strong>
        </td>
        <td>
            <div>
                <strong>${category.name}</strong>
            </div>
        </td>
        <td>
            <span class="text-muted">${category.description || 'Sin descripci√≥n'}</span>
        </td>
        <td class="text-center">
            <span class="badge bg-info">${productsInCategory}</span>
        </td>
        <td class="text-center">
            <span class="badge ${category.is_active ? 'bg-success' : 'bg-secondary'}">
                ${category.is_active ? 'Activa' : 'Inactiva'}
            </span>
        </td>
        <td class="text-center">
            <small class="text-muted">${formatDate(category.created_at)}</small>
        </td>
        <td class="text-center">
            <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-primary" onclick="editCategory(${category.id})" title="Editar">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${category.id})" title="Eliminar" ${productsInCategory > 0 ? 'disabled' : ''}>
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </td>
    `;
    
    return row;
}

// Actualizar estad√≠sticas de categor√≠as
function updateCategoryStatistics() {
    const total = categories.length;
    const active = categories.filter(c => c.is_active).length;
    const withProducts = categories.filter(c => products.some(p => p.category_id === c.id)).length;
    
    document.getElementById('totalCategories').textContent = total;
    document.getElementById('activeCategories').textContent = active;
    document.getElementById('categoriesWithProducts').textContent = withProducts;
}

// Guardar categor√≠a
async function saveCategory() {
    const form = document.getElementById('categoryForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const categoryData = {
        name: document.getElementById('categoryName').value,
        description: document.getElementById('categoryDescription').value,
        is_active: document.getElementById('categoryActive').checked
    };
    
    console.log('üè∑Ô∏è Datos de la categor√≠a a enviar:', categoryData);
    
    try {
        const categoryId = document.getElementById('categoryId').value;
        const url = categoryId ? `/api/v1/products/categories/${categoryId}` : '/api/v1/products/categories';
        const method = categoryId ? 'PUT' : 'POST';
        
        // Obtener token de autenticaci√≥n
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
            window.location.href = '/login';
            return;
        }

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(categoryData)
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Respuesta del servidor:', result);
            showAlert('Categor√≠a guardada exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
            form.reset();
            loadCategories();
            renderCategoriesTable();
            updateCategoryStatistics();
        } else {
            console.error('‚ùå Error HTTP:', response.status, response.statusText);
            const responseText = await response.text();
            console.error('‚ùå Respuesta del servidor (texto):', responseText);
            
            try {
                const error = JSON.parse(responseText);
                showAlert(`Error: ${error.detail || error.error || 'Error desconocido'}`, 'danger');
            } catch (e) {
                showAlert(`Error del servidor: ${response.status} - ${response.statusText}`, 'danger');
            }
        }
    } catch (error) {
        console.error('Error guardando categor√≠a:', error);
        showAlert('Error guardando categor√≠a', 'danger');
    }
}

// Editar categor√≠a
async function editCategory(categoryId) {
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
            window.location.href = '/login';
            return;
        }
        
        const response = await fetch(`/api/v1/products/categories/${categoryId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const category = await response.json();
        
        document.getElementById('categoryModalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Categor√≠a';
        document.getElementById('categoryId').value = category.id;
        document.getElementById('categoryName').value = category.name;
        document.getElementById('categoryDescription').value = category.description || '';
        document.getElementById('categoryActive').checked = category.is_active;
        
        const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
        modal.show();
    } catch (error) {
        console.error('Error cargando categor√≠a:', error);
        showAlert('Error cargando categor√≠a', 'danger');
    }
}

// Eliminar categor√≠a
async function deleteCategory(categoryId) {
    // Verificar si la categor√≠a tiene productos
    const productsInCategory = products.filter(p => p.category_id === categoryId).length;
    if (productsInCategory > 0) {
        showAlert('No se puede eliminar una categor√≠a que tiene productos asignados', 'warning');
        return;
    }
    
    if (!confirm('¬øEst√°s seguro de que quieres eliminar esta categor√≠a?')) {
        return;
    }
    
    try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            showAlert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
            window.location.href = '/login';
            return;
        }

        const response = await fetch(`/api/v1/products/categories/${categoryId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            showAlert('Categor√≠a eliminada exitosamente', 'success');
            loadCategories();
            renderCategoriesTable();
            updateCategoryStatistics();
        } else {
            const error = await response.json();
            showAlert(`Error: ${error.detail}`, 'danger');
        }
    } catch (error) {
        console.error('Error eliminando categor√≠a:', error);
        showAlert('Error eliminando categor√≠a', 'danger');
    }
}

// Formatear fecha
function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

// Limpiar formulario al cerrar modal de categor√≠a
document.getElementById('categoryModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryId').value = '';
    document.getElementById('categoryModalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nueva Categor√≠a';
    document.getElementById('categoryActive').checked = true;
});

// Event listener para b√∫squeda en tabla
document.addEventListener('DOMContentLoaded', function() {
    // Agregar event listener para b√∫squeda en tabla
    const tableSearchInput = document.getElementById('tableSearchInput');
    if (tableSearchInput) {
        tableSearchInput.addEventListener('input', function() {
            filterTableProducts(currentTableFilter);
        });
    }
});
</script>
{% endblock %}