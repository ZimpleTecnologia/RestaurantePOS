{% extends "base.html" %}

{% block title %}Sistema de Caja - Sistema POS{% endblock %}
{% block page_title %}Sistema de Caja{% endblock %}

{% block content %}
<div class="row">
    <!-- Panel de Estado de Caja -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold">Estado de Caja</h6>
            </div>
            <div class="card-body">
                <div id="cash-status">
                    <div class="text-center">
                        <i class="bi bi-hourglass-split fa-3x text-muted"></i>
                        <p class="mt-2">Cargando estado...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Acciones -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold">Acciones de Caja</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-success btn-lg w-100 mb-3" onclick="openCashSession()" id="btn-open">
                            <i class="bi bi-cash-coin"></i> Abrir Caja
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-danger btn-lg w-100 mb-3" onclick="closeCashSession()" id="btn-close" disabled>
                            <i class="bi bi-cash-stack"></i> Cerrar Caja
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-primary btn-lg w-100 mb-3" onclick="addMovement()" id="btn-movement" disabled>
                            <i class="bi bi-plus-circle"></i> Agregar Movimiento
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-info btn-lg w-100 mb-3" onclick="viewSummary()" id="btn-summary" disabled>
                            <i class="bi bi-file-earmark-text"></i> Ver Resumen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Sesiones -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold">Sesiones de Caja</h6>
                <div>
                    <select class="form-select form-select-sm" id="filter-status" onchange="loadSessions()">
                        <option value="">Todas las sesiones</option>
                        <option value="abierta">Sesiones abiertas</option>
                        <option value="cerrada">Sesiones cerradas</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="sessions-table">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Caja</th>
                                <th>Usuario</th>
                                <th>Apertura</th>
                                <th>Monto Inicial</th>
                                <th>Cierre</th>
                                <th>Monto Final</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="9" class="text-center">Cargando sesiones...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Abrir Caja -->
<div class="modal fade" id="openSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Abrir Caja</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="openSessionForm">
                    <div class="mb-3">
                        <label class="form-label">Caja</label>
                        <select class="form-select" id="cash-register-select" required>
                            <option value="">Seleccionar caja...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Monto Inicial</label>
                        <input type="number" class="form-control" id="opening-amount" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notas</label>
                        <textarea class="form-control" id="opening-notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="submitOpenSession()">
                    <i class="bi bi-check-circle"></i> Abrir Caja
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Cerrar Caja -->
<div class="modal fade" id="closeSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cerrar Caja</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="closeSessionForm">
                    <div class="mb-3">
                        <label class="form-label">Monto en Caja</label>
                        <input type="number" class="form-control" id="closing-amount" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notas</label>
                        <textarea class="form-control" id="closing-notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="submitCloseSession()">
                    <i class="bi bi-check-circle"></i> Cerrar Caja
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar Movimiento -->
<div class="modal fade" id="movementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Movimiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="movementForm">
                    <div class="mb-3">
                        <label class="form-label">Tipo de Movimiento</label>
                        <select class="form-select" id="movement-type" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="venta">Venta</option>
                            <option value="devolución">Devolución</option>
                            <option value="gasto">Gasto</option>
                            <option value="retiro">Retiro</option>
                            <option value="depósito">Depósito</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Monto</label>
                        <input type="number" class="form-control" id="movement-amount" step="0.01" min="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <input type="text" class="form-control" id="movement-description" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Referencia</label>
                        <input type="text" class="form-control" id="movement-reference">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notas</label>
                        <textarea class="form-control" id="movement-notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitMovement()">
                    <i class="bi bi-check-circle"></i> Agregar Movimiento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Resumen -->
<div class="modal fade" id="summaryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resumen de Sesión</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="summary-content">
                    <div class="text-center">
                        <i class="bi bi-hourglass-split fa-3x text-muted"></i>
                        <p class="mt-2">Cargando resumen...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-info" onclick="printSummary()">
                    <i class="bi bi-printer"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSession = null;
let cashRegisters = [];

$(document).ready(function() {
    loadCashStatus();
    loadCashRegisters();
    loadSessions();
});

function loadCashStatus() {
    $.ajax({
        url: '/api/v1/cash-register/sessions',
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        },
        data: { status: 'abierta' },
        success: function(data) {
            if (data.length > 0) {
                currentSession = data[0];
                updateCashStatus(true);
            } else {
                updateCashStatus(false);
            }
        },
        error: function() {
            updateCashStatus(false);
        }
    });
}

function updateCashStatus(isOpen) {
    const statusDiv = $('#cash-status');
    if (isOpen) {
        statusDiv.html(`
            <div class="text-center">
                <i class="bi bi-cash-coin fa-3x text-success"></i>
                <h5 class="mt-2 text-success">Caja Abierta</h5>
                <p class="text-muted">Sesión: ${currentSession.session_number}</p>
                <p class="text-muted">Usuario: ${currentSession.user_name}</p>
                <p class="text-muted">Apertura: ${new Date(currentSession.opened_at).toLocaleString()}</p>
            </div>
        `);
        $('#btn-open').prop('disabled', true);
        $('#btn-close').prop('disabled', false);
        $('#btn-movement').prop('disabled', false);
        $('#btn-summary').prop('disabled', false);
    } else {
        statusDiv.html(`
            <div class="text-center">
                <i class="bi bi-cash-stack fa-3x text-danger"></i>
                <h5 class="mt-2 text-danger">Caja Cerrada</h5>
                <p class="text-muted">No hay sesiones activas</p>
            </div>
        `);
        $('#btn-open').prop('disabled', false);
        $('#btn-close').prop('disabled', true);
        $('#btn-movement').prop('disabled', true);
        $('#btn-summary').prop('disabled', true);
    }
}

function loadCashRegisters() {
    $.ajax({
        url: '/api/v1/cash-register/registers',
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        },
        success: function(data) {
            cashRegisters = data;
            const select = $('#cash-register-select');
            select.empty();
            select.append('<option value="">Seleccionar caja...</option>');
            
            data.forEach(register => {
                select.append(`<option value="${register.id}">${register.name} (${register.register_number})</option>`);
            });
        },
        error: function() {
            alert('Error al cargar las cajas registradoras');
        }
    });
}

function loadSessions() {
    const status = $('#filter-status').val();
    const params = status ? { status: status } : {};
    
    $.ajax({
        url: '/api/v1/cash-register/sessions',
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        },
        data: params,
        success: function(data) {
            const tbody = $('#sessions-table tbody');
            tbody.empty();
            
            if (data.length === 0) {
                tbody.html('<tr><td colspan="9" class="text-center text-muted">No hay sesiones registradas</td></tr>');
            } else {
                data.forEach(session => {
                    const row = `
                        <tr>
                            <td>${session.session_number}</td>
                            <td>${session.cash_register_name}</td>
                            <td>${session.user_name}</td>
                            <td>${new Date(session.opened_at).toLocaleString()}</td>
                            <td>$${session.opening_amount}</td>
                            <td>${session.closed_at ? new Date(session.closed_at).toLocaleString() : '-'}</td>
                            <td>${session.closing_amount ? '$' + session.closing_amount : '-'}</td>
                            <td><span class="badge bg-${session.status === 'abierta' ? 'success' : 'secondary'}">${session.status}</span></td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-info" onclick="viewSessionDetails(${session.id})" title="Ver detalles">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewSessionSummary(${session.id})" title="Ver resumen">
                                        <i class="bi bi-file-earmark-text"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }
        },
        error: function() {
            $('#sessions-table tbody').html('<tr><td colspan="9" class="text-center text-danger">Error al cargar sesiones</td></tr>');
        }
    });
}

function openCashSession() {
    $('#openSessionModal').modal('show');
}

function submitOpenSession() {
    const formData = {
        cash_register_id: parseInt($('#cash-register-select').val()),
        opening_amount: parseFloat($('#opening-amount').val()),
        opening_notes: $('#opening-notes').val()
    };
    
    if (!formData.cash_register_id || !formData.opening_amount) {
        alert('Por favor complete todos los campos requeridos');
        return;
    }
    
    $.ajax({
        url: '/api/v1/cash-register/sessions',
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify(formData),
        success: function(response) {
            $('#openSessionModal').modal('hide');
            $('#openSessionForm')[0].reset();
            loadCashStatus();
            loadSessions();
            alert('Caja abierta correctamente');
        },
        error: function(xhr) {
            alert('Error al abrir la caja: ' + xhr.responseJSON?.detail || 'Error desconocido');
        }
    });
}

function closeCashSession() {
    $('#closeSessionModal').modal('show');
}

function submitCloseSession() {
    const formData = {
        closing_amount: parseFloat($('#closing-amount').val()),
        closing_notes: $('#closing-notes').val()
    };
    
    if (!formData.closing_amount) {
        alert('Por favor ingrese el monto en caja');
        return;
    }
    
    $.ajax({
        url: `/api/v1/cash-register/sessions/${currentSession.id}/close`,
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify(formData),
        success: function(response) {
            $('#closeSessionModal').modal('hide');
            $('#closeSessionForm')[0].reset();
            loadCashStatus();
            loadSessions();
            alert('Caja cerrada correctamente');
        },
        error: function(xhr) {
            alert('Error al cerrar la caja: ' + xhr.responseJSON?.detail || 'Error desconocido');
        }
    });
}

function addMovement() {
    $('#movementModal').modal('show');
}

function submitMovement() {
    const formData = {
        session_id: currentSession.id,
        movement_type: $('#movement-type').val(),
        amount: parseFloat($('#movement-amount').val()),
        description: $('#movement-description').val(),
        reference: $('#movement-reference').val(),
        notes: $('#movement-notes').val()
    };
    
    if (!formData.movement_type || !formData.amount || !formData.description) {
        alert('Por favor complete todos los campos requeridos');
        return;
    }
    
    $.ajax({
        url: '/api/v1/cash-register/movements',
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify(formData),
        success: function(response) {
            $('#movementModal').modal('hide');
            $('#movementForm')[0].reset();
            loadSessions();
            alert('Movimiento agregado correctamente');
        },
        error: function(xhr) {
            alert('Error al agregar movimiento: ' + xhr.responseJSON?.detail || 'Error desconocido');
        }
    });
}

function viewSummary() {
    if (!currentSession) return;
    viewSessionSummary(currentSession.id);
}

function viewSessionSummary(sessionId) {
    $.ajax({
        url: `/api/v1/cash-register/sessions/${sessionId}/summary`,
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        },
        success: function(data) {
            const summaryHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Información de Sesión</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Sesión:</strong></td><td>${data.session_number}</td></tr>
                            <tr><td><strong>Caja:</strong></td><td>${data.cash_register_name}</td></tr>
                            <tr><td><strong>Usuario:</strong></td><td>${data.user_name}</td></tr>
                            <tr><td><strong>Apertura:</strong></td><td>${new Date(data.opened_at).toLocaleString()}</td></tr>
                            <tr><td><strong>Cierre:</strong></td><td>${data.closed_at ? new Date(data.closed_at).toLocaleString() : 'Pendiente'}</td></tr>
                            <tr><td><strong>Estado:</strong></td><td><span class="badge bg-${data.status === 'abierta' ? 'success' : 'secondary'}">${data.status}</span></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Resumen Financiero</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Monto Inicial:</strong></td><td>$${data.opening_amount}</td></tr>
                            <tr><td><strong>Ventas:</strong></td><td>$${data.total_sales}</td></tr>
                            <tr><td><strong>Devoluciones:</strong></td><td>$${data.total_refunds}</td></tr>
                            <tr><td><strong>Gastos:</strong></td><td>$${data.total_expenses}</td></tr>
                            <tr><td><strong>Retiros:</strong></td><td>$${data.total_withdrawals}</td></tr>
                            <tr><td><strong>Depósitos:</strong></td><td>$${data.total_deposits}</td></tr>
                            <tr class="table-info"><td><strong>Monto Esperado:</strong></td><td>$${data.expected_amount}</td></tr>
                            ${data.closing_amount ? `<tr class="table-warning"><td><strong>Monto Final:</strong></td><td>$${data.closing_amount}</td></tr>` : ''}
                            ${data.difference !== null ? `<tr class="table-${data.difference >= 0 ? 'success' : 'danger'}"><td><strong>Diferencia:</strong></td><td>$${data.difference}</td></tr>` : ''}
                        </table>
                    </div>
                </div>
            `;
            
            $('#summary-content').html(summaryHtml);
            $('#summaryModal').modal('show');
        },
        error: function() {
            alert('Error al cargar el resumen de la sesión');
        }
    });
}

function viewSessionDetails(sessionId) {
    // Implementar vista detallada de la sesión
    alert('Funcionalidad en desarrollo');
}

function printSummary() {
    // Implementar impresión del resumen
    alert('Funcionalidad en desarrollo');
}
</script>
{% endblock %}
