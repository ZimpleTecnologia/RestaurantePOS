{% extends "base.html" %}

{% block title %}Panel de Cocina - Sistema POS{% endblock %}

{% block extra_css %}
<style>
    .kitchen-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        padding: 20px;
    }
    
    .order-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border-left: 5px solid var(--primary-color);
    }
    
    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }
    
    .order-card.pendiente {
        border-left-color: var(--warning-color);
        background-color: #fff8e1;
    }
    
    .order-card.en_preparacion {
        border-left-color: var(--primary-color);
        background-color: #e3f2fd;
    }
    
    .order-card.listo {
        border-left-color: var(--accent-color);
        background-color: #e8f5e8;
    }
    
    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .order-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .order-status {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-pendiente {
        background-color: var(--warning-color);
        color: black;
    }
    
    .status-en_preparacion {
        background-color: var(--primary-color);
        color: white;
    }
    
    .status-listo {
        background-color: var(--accent-color);
        color: white;
    }
    
    .order-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .info-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .info-item i {
        color: var(--primary-color);
        width: 20px;
    }
    
    .order-items {
        margin-bottom: 15px;
    }
    
    .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .item-quantity {
        background-color: var(--primary-color);
        color: white;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.8rem;
    }
    
    .order-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .btn-action {
        flex: 1;
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-start {
        background-color: var(--primary-color);
        color: white;
    }
    
    .btn-start:hover {
        background-color: var(--secondary-color);
    }
    
    .btn-ready {
        background-color: var(--accent-color);
        color: white;
    }
    
    .btn-ready:hover {
        background-color: #218838;
    }
    
    .btn-notes {
        background-color: var(--warning-color);
        color: black;
    }
    
    .btn-notes:hover {
        background-color: #e0a800;
    }
    
    .priority-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-left: 10px;
    }
    
    .priority-normal {
        background-color: #6c757d;
        color: white;
    }
    
    .priority-alta {
        background-color: var(--warning-color);
        color: black;
    }
    
    .priority-urgente {
        background-color: var(--danger-color);
        color: white;
    }
    
    .kitchen-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--primary-color);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    .kitchen-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .sound-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }
    
    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .slider {
        background-color: var(--accent-color);
    }
    
    input:checked + .slider:before {
        transform: translateX(26px);
    }
    
    .last-update {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-fire"></i> Panel de Cocina</h2>
    <div>
        <button class="btn btn-primary" onclick="refreshOrders()">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
        <button class="btn btn-success" onclick="viewWaitersPanel()">
            <i class="bi bi-person-badge"></i> Ver Meseros
        </button>
    </div>
</div>

<!-- Estadísticas de Cocina -->
<div class="kitchen-stats">
    <div class="stat-card">
        <div class="stat-number" id="total-orders">0</div>
        <div class="stat-label">Total Órdenes</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="pending-orders">0</div>
        <div class="stat-label">Pendientes</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="preparing-orders">0</div>
        <div class="stat-label">En Preparación</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="ready-orders">0</div>
        <div class="stat-label">Listas</div>
    </div>
</div>

<!-- Controles de Cocina -->
<div class="kitchen-controls">
    <div class="sound-toggle">
        <label class="toggle-switch">
            <input type="checkbox" id="sound-toggle" checked>
            <span class="slider"></span>
        </label>
        <span>Notificaciones de Sonido</span>
    </div>
    <div class="last-update">
        Última actualización: <span id="last-update-time">--</span>
    </div>
</div>

<!-- Grid de Órdenes -->
<div class="kitchen-grid" id="orders-grid">
    <!-- Las órdenes se cargarán dinámicamente aquí -->
</div>

<!-- Estado vacío -->
<div class="empty-state" id="empty-state" style="display: none;">
    <i class="bi bi-fire"></i>
    <h4>No hay órdenes pendientes</h4>
    <p>Las órdenes aparecerán aquí cuando los meseros las envíen</p>
</div>

<!-- Modal para Notas de Cocina -->
<div class="modal fade" id="kitchenNotesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil"></i> Notas de Cocina - Orden #<span id="notes-order-number"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Notas actuales:</label>
                    <textarea class="form-control" id="kitchen-notes" rows="4" 
                              placeholder="Agregar notas sobre la preparación..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveKitchenNotes()">
                    <i class="bi bi-check-circle"></i> Guardar Notas
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let orders = [];
    let lastOrderCount = 0;
    let soundEnabled = true;
    let selectedOrderId = null;

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        loadOrders();
        updateStats();
        
        // Auto-refresh cada 30 segundos
        setInterval(() => {
            loadOrders();
            updateStats();
        }, 30000);
        
        // Configurar toggle de sonido
        document.getElementById('sound-toggle').addEventListener('change', function() {
            soundEnabled = this.checked;
        });
    });

    // Cargar órdenes
    async function loadOrders() {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch('/api/v1/kitchen/orders', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const newOrders = await response.json();
                
                // Verificar nuevas órdenes y reproducir sonido
                if (soundEnabled && newOrders.length > lastOrderCount) {
                    playNotificationSound();
                }
                
                lastOrderCount = newOrders.length;
                orders = newOrders;
                updateStats();
                renderOrders();
                updateLastUpdateTime();
            } else {
                console.error('Error cargando órdenes');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Renderizar órdenes
    function renderOrders() {
        const grid = document.getElementById('orders-grid');
        const emptyState = document.getElementById('empty-state');
        
        if (orders.length === 0) {
            grid.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }
        
        grid.style.display = 'grid';
        emptyState.style.display = 'none';
        grid.innerHTML = '';

        orders.forEach(order => {
            const orderCard = document.createElement('div');
            orderCard.className = `order-card ${order.status}`;

            const priorityClass = `priority-${order.priority}`;
            const priorityText = getPriorityText(order.priority);

            orderCard.innerHTML = `
                <div class="order-header">
                    <div class="order-number">
                        #${order.order_number}
                        <span class="priority-badge ${priorityClass}">${priorityText}</span>
                    </div>
                    <div class="order-status status-${order.status}">${getStatusText(order.status)}</div>
                </div>
                
                <div class="order-info">
                    <div class="info-item">
                        <i class="bi bi-table"></i>
                        <span>Mesa ${order.table_number}</span>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-person"></i>
                        <span>${order.waiter_name}</span>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-people"></i>
                        <span>${order.people_count} personas</span>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-clock"></i>
                        <span>${formatTime(order.created_at)}</span>
                    </div>
                </div>
                
                <div class="order-items">
                    <h6>Productos:</h6>
                    ${order.items.map(item => `
                        <div class="order-item">
                            <div class="d-flex align-items-center">
                                <div class="item-quantity">${item.quantity}</div>
                                <span class="ms-2">${item.product ? item.product.name : 'Producto no encontrado'}</span>
                            </div>
                            ${item.special_instructions ? 
                                `<small class="text-warning">${item.special_instructions}</small>` : ''
                            }
                        </div>
                    `).join('')}
                </div>
                
                ${order.notes ? `
                    <div class="mb-3">
                        <strong>Notas del mesero:</strong>
                        <p class="text-muted mb-0">${order.notes}</p>
                    </div>
                ` : ''}
                
                ${order.kitchen_notes ? `
                    <div class="mb-3">
                        <strong>Notas de cocina:</strong>
                        <p class="text-info mb-0">${order.kitchen_notes}</p>
                    </div>
                ` : ''}
                
                <div class="order-actions">
                    ${order.status === 'pendiente' ? `
                        <button class="btn-action btn-start" onclick="startPreparation(${order.id})">
                            <i class="bi bi-play-circle"></i> Iniciar
                        </button>
                    ` : ''}
                    
                    ${order.status === 'en_preparacion' ? `
                        <button class="btn-action btn-ready" onclick="markAsReady(${order.id})">
                            <i class="bi bi-check-circle"></i> Listo
                        </button>
                    ` : ''}
                    
                    <button class="btn-action btn-notes" onclick="openKitchenNotes(${order.id})">
                        <i class="bi bi-pencil"></i> Notas
                    </button>
                </div>
            `;

            grid.appendChild(orderCard);
        });
    }

    // Iniciar preparación
    async function startPreparation(orderId) {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/kitchen/orders/${orderId}/start`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                showSuccess('Orden iniciada en preparación');
                refreshOrders();
            } else {
                const error = await response.json();
                showError(error.detail || 'Error iniciando preparación');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // Marcar como listo
    async function markAsReady(orderId) {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/kitchen/orders/${orderId}/complete`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                showSuccess('Orden marcada como lista');
                playNotificationSound(); // Notificar a meseros
                refreshOrders();
            } else {
                const error = await response.json();
                showError(error.detail || 'Error completando orden');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // Abrir notas de cocina
    function openKitchenNotes(orderId) {
        selectedOrderId = orderId;
        const order = orders.find(o => o.id === orderId);
        
        if (order) {
            document.getElementById('notes-order-number').textContent = order.order_number;
            document.getElementById('kitchen-notes').value = order.kitchen_notes || '';
            new bootstrap.Modal(document.getElementById('kitchenNotesModal')).show();
        }
    }

    // Guardar notas de cocina
    async function saveKitchenNotes() {
        if (!selectedOrderId) return;

        const notes = document.getElementById('kitchen-notes').value;

        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/kitchen/orders/${selectedOrderId}/notes`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ kitchen_notes: notes })
            });

            if (response.ok) {
                showSuccess('Notas guardadas');
                bootstrap.Modal.getInstance(document.getElementById('kitchenNotesModal')).hide();
                refreshOrders();
            } else {
                const error = await response.json();
                showError(error.detail || 'Error guardando notas');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // Ver panel de meseros
    function viewWaitersPanel() {
        window.location.href = '/waiters';
    }

    // Actualizar estadísticas
    function updateStats() {
        document.getElementById('total-orders').textContent = orders.length;
        document.getElementById('pending-orders').textContent = 
            orders.filter(o => o.status === 'pendiente').length;
        document.getElementById('preparing-orders').textContent = 
            orders.filter(o => o.status === 'en_preparacion').length;
        document.getElementById('ready-orders').textContent = 
            orders.filter(o => o.status === 'listo').length;
    }

    // Refrescar órdenes
    function refreshOrders() {
        loadOrders();
        updateStats();
    }

    // Actualizar tiempo de última actualización
    function updateLastUpdateTime() {
        const now = new Date();
        document.getElementById('last-update-time').textContent = 
            now.toLocaleTimeString('es-ES');
    }

    // Reproducir sonido de notificación
    function playNotificationSound() {
        // Crear un audio simple para notificación
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
        audio.play().catch(e => console.log('No se pudo reproducir el sonido'));
    }

    // Utilidades
    function getStatusText(status) {
        const statusMap = {
            'pendiente': 'Pendiente',
            'en_preparacion': 'En Preparación',
            'listo': 'Listo',
            'servido': 'Servido'
        };
        return statusMap[status] || status;
    }

    function getPriorityText(priority) {
        const priorityMap = {
            'normal': 'Normal',
            'alta': 'Alta',
            'urgente': 'Urgente'
        };
        return priorityMap[priority] || priority;
    }

    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('es-ES', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }

    function showSuccess(message) {
        // Implementar toast de éxito
        alert(message);
    }

    function showError(message) {
        // Implementar toast de error
        alert('Error: ' + message);
    }
</script>
{% endblock %}
