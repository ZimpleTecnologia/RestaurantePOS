{% extends "base.html" %}

{% block title %}Panel de Meseros - Sistema POS{% endblock %}

{% block extra_css %}
<style>
    .table-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        padding: 20px;
    }
    
    .table-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        border: 3px solid transparent;
    }
    
    .table-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }
    
    .table-card.free {
        border-color: var(--accent-color);
    }
    
    .table-card.occupied {
        border-color: var(--warning-color);
        background-color: #fff8e1;
    }
    
    .table-card.reserved {
        border-color: var(--primary-color);
        background-color: #e3f2fd;
    }
    
    .table-card.maintenance {
        border-color: var(--danger-color);
        background-color: #ffebee;
    }
    
    .table-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .table-status {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-free {
        background-color: var(--accent-color);
        color: white;
    }
    
    .status-occupied {
        background-color: var(--warning-color);
        color: black;
    }
    
    .status-reserved {
        background-color: var(--primary-color);
        color: white;
    }
    
    .status-maintenance {
        background-color: var(--danger-color);
        color: white;
    }
    
    /* Botones de acción en las mesas */
    .table-actions {
        position: absolute;
        top: 5px;
        right: 5px;
        display: none;
    }
    
    .table-card:hover .table-actions {
        display: block;
    }
    
    .table-action-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: none;
        margin: 2px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .table-action-btn:hover {
        transform: scale(1.1);
    }
    
    .btn-new-order {
        background-color: var(--accent-color);
        color: white;
    }
    
    .btn-view-orders {
        background-color: var(--primary-color);
        color: white;
    }
    
    .btn-serve-orders {
        background-color: var(--success-color);
        color: white;
    }
    
    .btn-edit-orders {
        background-color: var(--warning-color);
        color: white;
    }
    
    /* Colores de mesas según estado de órdenes */
    .table-card.order-libre {
        border-color: var(--accent-color);
    }
    
    .table-card.order-pendiente {
        border-color: var(--warning-color);
        background-color: #fff3cd;
    }
    
    .table-card.order-en_preparacion {
        border-color: var(--primary-color);
        background-color: #e3f2fd;
    }
    
    .table-card.order-listo {
        border-color: var(--success-color);
        background-color: #d4edda;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .order-status-pendiente {
        color: var(--warning-color);
        font-weight: bold;
    }
    
    .order-status-en_preparacion {
        color: var(--primary-color);
        font-weight: bold;
    }
    
    .order-status-listo {
        color: var(--success-color);
        font-weight: bold;
    }
    
    /* Estilos para el modal de venta */
    .sale-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        margin-bottom: 5px;
    }
    
    .sale-item:last-child {
        border-bottom: none;
    }
    
    #sale-items-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .order-modal .modal-content {
        border-radius: 15px;
    }
    
    .product-item {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        border-left: 4px solid var(--primary-color);
    }
    
    .product-item.selected {
        background-color: #e3f2fd;
        border-left-color: var(--accent-color);
    }
    
    .quantity-control {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .quantity-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: none;
        background-color: var(--primary-color);
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
    
    .quantity-btn:hover {
        background-color: var(--secondary-color);
    }
    
    .order-summary {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .kitchen-status {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .status-pendiente {
        background-color: var(--warning-color);
        color: black;
    }
    
    .status-en_preparacion {
        background-color: var(--primary-color);
        color: white;
    }
    
    .status-listo {
        background-color: var(--accent-color);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-person-badge"></i> Panel de Meseros</h2>
    <div>
        <button class="btn btn-warning" onclick="showAddTableModal()">
            <i class="bi bi-plus-circle"></i> Crear Mesa
        </button>
        <button class="btn btn-info" onclick="showMyOrders()">
            <i class="bi bi-list-check"></i> Mis Pedidos
        </button>
        <button class="btn btn-primary" onclick="refreshTables()">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
        <button class="btn btn-success" onclick="viewKitchenOrders()">
            <i class="bi bi-fire"></i> Ver Cocina
        </button>
    </div>
</div>

<!-- Estadísticas rápidas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h4 id="total-tables">0</h4>
                <p class="mb-0">Total Mesas</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h4 id="occupied-tables">0</h4>
                <p class="mb-0">Ocupadas</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h4 id="pending-orders">0</h4>
                <p class="mb-0">Órdenes Pendientes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h4 id="ready-orders">0</h4>
                <p class="mb-0">Listas para Servir</p>
            </div>
        </div>
    </div>
</div>

<!-- Grid de Mesas -->
<div class="table-grid" id="tables-grid">
    <!-- Las mesas se cargarán dinámicamente aquí -->
</div>

<!-- Modal para Crear Orden -->
<div class="modal fade order-modal" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Nueva Orden - Mesa <span id="modal-table-number"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Productos Disponibles</h6>
                        <div id="products-list">
                            <!-- Los productos se cargarán aquí -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Orden Actual</h6>
                        <div class="order-summary" id="order-summary">
                            <p class="text-muted">No hay productos seleccionados</p>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Notas para la cocina:</label>
                            <textarea class="form-control" id="order-notes" rows="3" 
                                      placeholder="Instrucciones especiales..."></textarea>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Prioridad:</label>
                            <select class="form-select" id="order-priority">
                                <option value="normal">Normal</option>
                                <option value="alta">Alta</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitOrder()">
                    <i class="bi bi-check-circle"></i> Enviar a Cocina
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Órdenes de Mesa -->
<div class="modal fade" id="tableOrdersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-list-ul"></i> Órdenes de Mesa <span id="modal-table-orders-number"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="table-orders-list">
                    <!-- Las órdenes se cargarán aquí -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-warning" onclick="editOrder()">
                    <i class="bi bi-pencil"></i> Editar Orden
                </button>
                <button type="button" class="btn btn-success" onclick="markAsServed()">
                    <i class="bi bi-check-circle"></i> Marcar como Servido
                </button>
                <button type="button" class="btn btn-primary" onclick="convertToSale()">
                    <i class="bi bi-cart-check"></i> Convertir a Venta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Crear Mesa -->
<div class="modal fade" id="addTableModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Crear Nueva Mesa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-table-form">
                    <div class="mb-3">
                        <label for="table-number" class="form-label">Número de Mesa</label>
                        <input type="number" class="form-control" id="table-number" required min="1">
                    </div>
                    <div class="mb-3">
                        <label for="table-capacity" class="form-label">Capacidad</label>
                        <input type="number" class="form-control" id="table-capacity" required min="1" max="20" value="4">
                    </div>
                    <div class="mb-3">
                        <label for="table-name" class="form-label">Nombre (Opcional)</label>
                        <input type="text" class="form-control" id="table-name" placeholder="Ej: Terraza, Interior, etc.">
                    </div>
                    <div class="mb-3">
                        <label for="table-notes" class="form-label">Notas (Opcional)</label>
                        <textarea class="form-control" id="table-notes" rows="3" placeholder="Notas adicionales sobre la mesa"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitAddTable()">
                    <i class="bi bi-check-circle"></i> Crear Mesa
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Mis Pedidos -->
<div class="modal fade" id="myOrdersModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-list-check"></i> Mis Pedidos Activos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="my-orders-container">
                    <!-- Los pedidos del mesero se cargarán aquí -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Orden -->
<div class="modal fade" id="editOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil"></i> Editar Orden #<span id="edit-order-number"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Agregar Más Productos</h6>
                        <div id="edit-products-list">
                            <!-- Los productos se cargarán aquí -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Orden Actual</h6>
                        <div class="order-summary" id="edit-order-summary">
                            <!-- El resumen se cargará aquí -->
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Notas para la cocina:</label>
                            <textarea class="form-control" id="edit-order-notes" rows="3"></textarea>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Prioridad:</label>
                            <select class="form-select" id="edit-order-priority">
                                <option value="normal">Normal</option>
                                <option value="alta">Alta</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitEditOrder()">
                    <i class="bi bi-check-circle"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Venta -->
<div class="modal fade" id="saleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-cart-check"></i> Convertir a Venta - Orden #<span id="sale-order-number"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Detalles de la Venta</h6>
                        <div class="mb-3">
                            <label class="form-label">Mesa:</label>
                            <input type="text" class="form-control" id="sale-table-number" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cliente:</label>
                            <input type="text" class="form-control" id="sale-customer-name" placeholder="Nombre del cliente">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Método de Pago:</label>
                            <select class="form-select" id="sale-payment-method">
                                <option value="efectivo">Efectivo</option>
                                <option value="tarjeta">Tarjeta</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notas:</label>
                            <textarea class="form-control" id="sale-notes" rows="3" placeholder="Notas adicionales"></textarea>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Productos</h6>
                        <div id="sale-items-list">
                            <!-- Los items se cargarán aquí -->
                        </div>
                        <div class="mt-3">
                            <h5>Total: <span id="sale-total" class="text-primary"></span></h5>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="sale-order-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="processSale()">
                    <i class="bi bi-cart-check"></i> Procesar Venta
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTables = [];
    let currentProducts = [];
    let currentOrder = [];
    let selectedTableId = null;
    let selectedOrderId = null;
    let currentUser = null;
    let editingOrder = null;
    let editingOrderItems = [];
    let newOrderItems = [];

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        loadCurrentUser();
        loadTables();
        loadProducts();
        updateStats();
        
        // Auto-refresh cada 30 segundos
        setInterval(() => {
            loadTables();
            updateStats();
        }, 30000);
    });

    // Cargar usuario actual
    async function loadCurrentUser() {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch('/api/v1/auth/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                currentUser = await response.json();
            } else {
                console.error('Error cargando usuario');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Cargar mesas
    async function loadTables() {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch('/api/v1/tables/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                currentTables = await response.json();
                renderTables();
            } else {
                console.error('Error cargando mesas');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Cargar productos
    async function loadProducts() {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch('/api/v1/products/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                currentProducts = await response.json();
                renderProducts();
            } else {
                console.error('Error cargando productos');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Renderizar mesas
    function renderTables() {
        const grid = document.getElementById('tables-grid');
        grid.innerHTML = '';

        currentTables.forEach(table => {
            const tableCard = document.createElement('div');
            
            // Determinar el color de la mesa según el estado de las órdenes
            let orderStatus = 'libre';
            let orderCount = 0;
            
            if (table.active_orders && table.active_orders > 0) {
                orderCount = table.active_orders;
                // Si tiene órdenes activas, determinar el estado más crítico
                if (table.order_statuses) {
                    if (table.order_statuses.includes('listo')) {
                        orderStatus = 'listo';
                    } else if (table.order_statuses.includes('en_preparacion')) {
                        orderStatus = 'en_preparacion';
                    } else if (table.order_statuses.includes('pendiente')) {
                        orderStatus = 'pendiente';
                    }
                }
            }
            
            tableCard.className = `table-card ${table.status} order-${orderStatus}`;
            tableCard.onclick = () => openTable(table);

            const statusClass = `status-${table.status}`;
            const statusText = getStatusText(table.status);

            // Determinar botones de acción según el estado
            let actionButtons = '';
            if (orderStatus === 'libre' || table.status === 'libre') {
                actionButtons = `
                    <button class="table-action-btn btn-new-order" onclick="event.stopPropagation(); createNewOrder(${table.id})" title="Crear Nuevo Pedido">
                        <i class="bi bi-plus"></i>
                    </button>
                `;
            } else if (orderStatus === 'listo') {
                actionButtons = `
                    <button class="table-action-btn btn-serve-orders" onclick="event.stopPropagation(); serveOrders(${table.id})" title="Servir Órdenes">
                        <i class="bi bi-check"></i>
                    </button>
                    <button class="table-action-btn btn-view-orders" onclick="event.stopPropagation(); viewTableOrders(${table.id})" title="Ver Órdenes">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="table-action-btn btn-edit-orders" onclick="event.stopPropagation(); editTableOrders(${table.id})" title="Editar Órdenes">
                        <i class="bi bi-pencil"></i>
                    </button>
                `;
            } else {
                actionButtons = `
                    <button class="table-action-btn btn-view-orders" onclick="event.stopPropagation(); viewTableOrders(${table.id})" title="Ver Órdenes">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="table-action-btn btn-edit-orders" onclick="event.stopPropagation(); editTableOrders(${table.id})" title="Editar Órdenes">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="table-action-btn btn-new-order" onclick="event.stopPropagation(); createNewOrder(${table.id})" title="Agregar Pedido">
                        <i class="bi bi-plus"></i>
                    </button>
                `;
            }

            tableCard.innerHTML = `
                <div class="table-actions">
                    ${actionButtons}
                </div>
                <div class="table-number">${table.table_number}</div>
                <div class="table-status ${statusClass}">${statusText}</div>
                ${table.capacity ? `<div class="mt-2"><small>Capacidad: ${table.capacity}</small></div>` : ''}
                ${orderCount > 0 ? `<div class="mt-2"><small class="text-warning">Órdenes activas: ${orderCount}</small></div>` : ''}
                ${orderStatus !== 'libre' ? `<div class="mt-2"><small class="order-status-${orderStatus}">Estado: ${getStatusText(orderStatus)}</small></div>` : ''}
            `;

            grid.appendChild(tableCard);
        });
    }

    // Renderizar productos
    function renderProducts() {
        const container = document.getElementById('products-list');
        container.innerHTML = '';

        currentProducts.forEach(product => {
            const productItem = document.createElement('div');
            productItem.className = 'product-item';
            productItem.onclick = () => selectProduct(product);

            productItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${product.name}</strong>
                        <br>
                        <small class="text-muted">${product.description || 'Sin descripción'}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold">$${product.price}</div>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="event.stopPropagation(); decreaseQuantity(${product.id})">-</button>
                            <span id="qty-${product.id}">0</span>
                            <button class="quantity-btn" onclick="event.stopPropagation(); increaseQuantity(${product.id})">+</button>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(productItem);
        });
    }

    // Abrir mesa
    function openTable(table) {
        if (table.status === 'free') {
            // Mesa libre - crear nueva orden
            selectedTableId = table.id;
            document.getElementById('modal-table-number').textContent = table.table_number;
            currentOrder = [];
            updateOrderSummary();
            new bootstrap.Modal(document.getElementById('orderModal')).show();
        } else if (table.status === 'occupied') {
            // Mesa ocupada - ver órdenes existentes
            selectedTableId = table.id;
            document.getElementById('modal-table-orders-number').textContent = table.table_number;
            loadTableOrders(table.id);
            new bootstrap.Modal(document.getElementById('tableOrdersModal')).show();
        }
    }

    // Seleccionar producto
    function selectProduct(product) {
        const existingItem = currentOrder.find(item => item.product_id === product.id);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            currentOrder.push({
                product_id: product.id,
                product_name: product.name,
                price: product.price,
                quantity: 1
            });
        }
        
        updateOrderSummary();
        updateProductQuantities();
    }

    // Aumentar cantidad
    function increaseQuantity(productId) {
        const existingItem = currentOrder.find(item => item.product_id === productId);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            const product = currentProducts.find(p => p.id === productId);
            if (product) {
                currentOrder.push({
                    product_id: product.id,
                    product_name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
        }
        
        updateOrderSummary();
        updateProductQuantities();
    }

    // Disminuir cantidad
    function decreaseQuantity(productId) {
        const existingItem = currentOrder.find(item => item.product_id === productId);
        
        if (existingItem) {
            existingItem.quantity -= 1;
            if (existingItem.quantity <= 0) {
                currentOrder = currentOrder.filter(item => item.product_id !== productId);
            }
        }
        
        updateOrderSummary();
        updateProductQuantities();
    }

    // Actualizar resumen de orden
    function updateOrderSummary() {
        const container = document.getElementById('order-summary');
        
        if (currentOrder.length === 0) {
            container.innerHTML = '<p class="text-muted">No hay productos seleccionados</p>';
            return;
        }

        let html = '';
        let total = 0;

        currentOrder.forEach(item => {
            const subtotal = item.price * item.quantity;
            total += subtotal;
            
            html += `
                <div class="order-item">
                    <div>
                        <strong>${item.product_name}</strong>
                        <br>
                        <small class="text-muted">$${item.price} x ${item.quantity}</small>
                    </div>
                    <div class="text-end">
                        <strong>$${subtotal.toFixed(2)}</strong>
                        <br>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromOrder(${item.product_id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        html += `
            <hr>
            <div class="order-item">
                <strong>Total:</strong>
                <strong>$${total.toFixed(2)}</strong>
            </div>
        `;

        container.innerHTML = html;
    }

    // Actualizar cantidades mostradas
    function updateProductQuantities() {
        currentOrder.forEach(item => {
            const qtyElement = document.getElementById(`qty-${item.product_id}`);
            if (qtyElement) {
                qtyElement.textContent = item.quantity;
            }
        });
    }

    // Remover de orden
    function removeFromOrder(productId) {
        currentOrder = currentOrder.filter(item => item.product_id !== productId);
        updateOrderSummary();
        updateProductQuantities();
    }

    // Enviar orden
    async function submitOrder() {
        if (currentOrder.length === 0) {
            alert('Debe seleccionar al menos un producto');
            return;
        }

        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const orderData = {
                table_id: selectedTableId,
                items: currentOrder.map(item => ({
                    product_id: item.product_id,
                    quantity: item.quantity
                })),
                notes: document.getElementById('order-notes').value,
                priority: document.getElementById('order-priority').value
            };

            const response = await fetch('/api/v1/orders/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                showSuccess('Orden enviada a cocina exitosamente');
                bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
                loadTables();
                updateStats();
            } else {
                const error = await response.json();
                showError(error.detail || 'Error enviando orden');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // Cargar órdenes de mesa
    async function loadTableOrders(tableId) {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/orders/?table_id=${tableId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const orders = await response.json();
                renderTableOrders(orders);
            } else {
                console.error('Error cargando órdenes de mesa');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Renderizar órdenes de mesa
    function renderTableOrders(orders) {
        const container = document.getElementById('table-orders-list');
        
        if (orders.length === 0) {
            container.innerHTML = '<p class="text-muted">No hay órdenes para esta mesa</p>';
            return;
        }

        let html = '';
        orders.forEach(order => {
            html += `
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Orden #${order.order_number}</strong>
                        <span class="kitchen-status status-${order.status}">${getStatusText(order.status)}</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Productos:</h6>
                                <ul class="list-unstyled">
                                    ${order.items.map(item => `
                                        <li>
                                            <strong>${item.quantity}x</strong> ${item.product ? item.product.name : 'Producto no encontrado'}
                                            ${item.special_instructions ? `<br><small class="text-warning">${item.special_instructions}</small>` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6>Información:</h6>
                                <p><strong>Prioridad:</strong> ${order.priority}</p>
                                <p><strong>Estado:</strong> ${getStatusText(order.status)}</p>
                                ${order.notes ? `<p><strong>Notas:</strong> ${order.notes}</p>` : ''}
                                ${order.kitchen_notes ? `<p><strong>Notas de cocina:</strong> ${order.kitchen_notes}</p>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Marcar como servido
    async function markAsServed() {
        if (!selectedOrderId) {
            showError('Debe seleccionar una orden');
            return;
        }

        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/orders/${selectedOrderId}/status`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ new_status: 'servido' })
            });

            if (response.ok) {
                showSuccess('Orden marcada como servida');
                bootstrap.Modal.getInstance(document.getElementById('tableOrdersModal')).hide();
                loadTables();
                updateStats();
            } else {
                const error = await response.json();
                showError(error.detail || 'Error marcando orden como servida');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // Ver órdenes de cocina
    function viewKitchenOrders() {
        window.location.href = '/kitchen';
    }

    // Actualizar estadísticas
    async function updateStats() {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            
            // Estadísticas de mesas
            const tablesResponse = await fetch('/api/v1/tables/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (tablesResponse.ok) {
                const tables = await tablesResponse.json();
                document.getElementById('total-tables').textContent = tables.length;
                document.getElementById('occupied-tables').textContent = 
                    tables.filter(t => t.status === 'occupied').length;
            }

            // Estadísticas de órdenes
            const ordersResponse = await fetch('/api/v1/orders/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (ordersResponse.ok) {
                const orders = await ordersResponse.json();
                document.getElementById('pending-orders').textContent = 
                    orders.filter(o => o.status === 'pendiente').length;
                document.getElementById('ready-orders').textContent = 
                    orders.filter(o => o.status === 'listo').length;
            }
        } catch (error) {
            console.error('Error actualizando estadísticas:', error);
        }
    }

    // Refrescar mesas
    function refreshTables() {
        loadTables();
        updateStats();
    }

    // Utilidades
    function getStatusText(status) {
        const statusMap = {
            'free': 'Libre',
            'occupied': 'Ocupada',
            'reserved': 'Reservada',
            'maintenance': 'Mantenimiento',
            'pendiente': 'Pendiente',
            'en_preparacion': 'En Preparación',
            'listo': 'Listo',
            'servido': 'Servido'
        };
        return statusMap[status] || status;
    }

    function showSuccess(message) {
        // Implementar toast de éxito
        alert(message);
    }

    function showError(message) {
        // Implementar toast de error
        alert('Error: ' + message);
    }

    // ===== FUNCIONES PARA CREAR MESAS =====
    
    // Mostrar modal de crear mesa
    function showAddTableModal() {
        // Limpiar formulario
        document.getElementById('add-table-form').reset();
        
        // Auto-generar siguiente número de mesa
        const nextNumber = Math.max(...currentTables.map(t => parseInt(t.table_number) || 0), 0) + 1;
        document.getElementById('table-number').value = nextNumber;
        
        new bootstrap.Modal(document.getElementById('addTableModal')).show();
    }

    // Crear mesa
    async function submitAddTable() {
        const form = document.getElementById('add-table-form');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const tableData = {
            table_number: document.getElementById('table-number').value.toString(),
            capacity: parseInt(document.getElementById('table-capacity').value),
            name: document.getElementById('table-name').value || null,
            notes: document.getElementById('table-notes').value || null
        };

        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch('/api/v1/tables/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(tableData)
            });

            if (response.ok) {
                showSuccess('Mesa creada exitosamente');
                bootstrap.Modal.getInstance(document.getElementById('addTableModal')).hide();
                loadTables();
            } else {
                const error = await response.json();
                showError(error.detail || 'Error creando mesa');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // ===== FUNCIONES PARA MIS PEDIDOS =====
    
    // Mostrar mis pedidos
    async function showMyOrders() {
        if (!currentUser) {
            showError('Usuario no cargado');
            return;
        }

        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/orders/?waiter_id=${currentUser.id}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const orders = await response.json();
                renderMyOrders(orders);
                new bootstrap.Modal(document.getElementById('myOrdersModal')).show();
            } else {
                showError('Error cargando pedidos');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // Renderizar mis pedidos
    function renderMyOrders(orders) {
        const container = document.getElementById('my-orders-container');
        
        if (orders.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">No tienes pedidos activos</p>';
            return;
        }

        let html = '';
        orders.forEach(order => {
            const statusClass = `status-${order.status}`;
            const statusText = getStatusText(order.status);
            
            html += `
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Orden #${order.order_number}</strong> - Mesa ${order.table ? order.table.table_number : 'N/A'}
                        </div>
                        <div>
                            <span class="kitchen-status ${statusClass}">${statusText}</span>
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="editOrderFromList(${order.id})">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            ${order.status === 'listo' ? `
                                <button class="btn btn-sm btn-primary ms-2" onclick="convertOrderToSale(${order.id})">
                                    <i class="bi bi-cart-check"></i> Vender
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Productos:</h6>
                                <ul class="list-unstyled">
                                    ${order.items.map(item => `
                                        <li>
                                            <strong>${item.quantity}x</strong> ${item.product ? item.product.name : 'Producto no encontrado'}
                                            ${item.special_instructions ? `<br><small class="text-warning">${item.special_instructions}</small>` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6>Información:</h6>
                                <p><strong>Prioridad:</strong> ${order.priority}</p>
                                <p><strong>Estado:</strong> ${statusText}</p>
                                <p><strong>Creado:</strong> ${formatTime(order.created_at)}</p>
                                ${order.notes ? `<p><strong>Notas:</strong> ${order.notes}</p>` : ''}
                                ${order.kitchen_notes ? `<p><strong>Notas de cocina:</strong> ${order.kitchen_notes}</p>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // ===== FUNCIONES PARA EDITAR ÓRDENES =====
    
    // Editar orden desde lista de órdenes de mesa
    function editOrder() {
        if (!selectedOrderId) {
            showError('Debe seleccionar una orden');
            return;
        }
        editOrderFromList(selectedOrderId);
    }

    // Editar orden desde lista de mis pedidos
    async function editOrderFromList(orderId) {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/orders/${orderId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                editingOrder = await response.json();
                editingOrderItems = [...editingOrder.items];
                newOrderItems = [];
                
                // Llenar el modal con los datos de la orden
                document.getElementById('edit-order-number').textContent = editingOrder.order_number;
                document.getElementById('edit-order-notes').value = editingOrder.notes || '';
                document.getElementById('edit-order-priority').value = editingOrder.priority;
                
                // Renderizar productos y resumen
                renderEditProducts();
                updateEditOrderSummary();
                
                // Mostrar modal
                new bootstrap.Modal(document.getElementById('editOrderModal')).show();
            } else {
                showError('Error cargando orden');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // Renderizar productos para edición
    function renderEditProducts() {
        const container = document.getElementById('edit-products-list');
        container.innerHTML = '';

        currentProducts.forEach(product => {
            const productItem = document.createElement('div');
            productItem.className = 'product-item';
            productItem.onclick = () => addToEditOrder(product);

            productItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${product.name}</strong>
                        <br>
                        <small class="text-muted">${product.description || 'Sin descripción'}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold">$${product.price}</div>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="event.stopPropagation(); decreaseEditQuantity(${product.id})">-</button>
                            <span id="edit-qty-${product.id}">0</span>
                            <button class="quantity-btn" onclick="event.stopPropagation(); increaseEditQuantity(${product.id})">+</button>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(productItem);
        });
    }

    // Agregar producto a orden en edición
    function addToEditOrder(product) {
        const existingItem = newOrderItems.find(item => item.product_id === product.id);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            newOrderItems.push({
                product_id: product.id,
                product_name: product.name,
                price: product.price,
                quantity: 1
            });
        }
        
        updateEditOrderSummary();
        updateEditProductQuantities();
    }

    // Aumentar cantidad en edición
    function increaseEditQuantity(productId) {
        const existingItem = newOrderItems.find(item => item.product_id === productId);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            const product = currentProducts.find(p => p.id === productId);
            if (product) {
                newOrderItems.push({
                    product_id: product.id,
                    product_name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
        }
        
        updateEditOrderSummary();
        updateEditProductQuantities();
    }

    // Disminuir cantidad en edición
    function decreaseEditQuantity(productId) {
        const existingItem = newOrderItems.find(item => item.product_id === productId);
        
        if (existingItem) {
            existingItem.quantity -= 1;
            if (existingItem.quantity <= 0) {
                newOrderItems = newOrderItems.filter(item => item.product_id !== productId);
            }
        }
        
        updateEditOrderSummary();
        updateEditProductQuantities();
    }

    // Actualizar resumen de orden en edición
    function updateEditOrderSummary() {
        const container = document.getElementById('edit-order-summary');
        
        let html = '';
        let total = 0;

        // Mostrar items actuales
        if (editingOrderItems.length > 0) {
            html += '<h6 class="text-muted">Items Actuales:</h6>';
            editingOrderItems.forEach(item => {
                const subtotal = item.unit_price * item.quantity;
                total += subtotal;
                
                html += `
                    <div class="order-item">
                        <div>
                            <strong>${item.product ? item.product.name : 'Producto'}</strong>
                            <br>
                            <small class="text-muted">$${item.unit_price} x ${item.quantity}</small>
                        </div>
                        <div class="text-end">
                            <strong>$${subtotal.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
            });
        }

        // Mostrar nuevos items
        if (newOrderItems.length > 0) {
            html += '<h6 class="text-success mt-3">Nuevos Items:</h6>';
            newOrderItems.forEach(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                
                html += `
                    <div class="order-item">
                        <div>
                            <strong class="text-success">${item.product_name}</strong>
                            <br>
                            <small class="text-muted">$${item.price} x ${item.quantity}</small>
                        </div>
                        <div class="text-end">
                            <strong class="text-success">$${subtotal.toFixed(2)}</strong>
                            <br>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFromEditOrder(${item.product_id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        html += `
            <hr>
            <div class="order-item">
                <strong>Total:</strong>
                <strong>$${total.toFixed(2)}</strong>
            </div>
        `;

        container.innerHTML = html;
    }

    // Actualizar cantidades mostradas en edición
    function updateEditProductQuantities() {
        newOrderItems.forEach(item => {
            const qtyElement = document.getElementById(`edit-qty-${item.product_id}`);
            if (qtyElement) {
                qtyElement.textContent = item.quantity;
            }
        });
    }

    // Remover de orden en edición
    function removeFromEditOrder(productId) {
        newOrderItems = newOrderItems.filter(item => item.product_id !== productId);
        updateEditOrderSummary();
        updateEditProductQuantities();
    }

    // Guardar cambios de orden
    async function submitEditOrder() {
        if (!editingOrder) return;

        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            
            // Actualizar información básica de la orden
            const orderUpdate = {
                notes: document.getElementById('edit-order-notes').value,
                priority: document.getElementById('edit-order-priority').value
            };

            const updateResponse = await fetch(`/api/v1/orders/${editingOrder.id}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderUpdate)
            });

            if (!updateResponse.ok) {
                showError('Error actualizando orden');
                return;
            }

            // Agregar nuevos items si hay
            if (newOrderItems.length > 0) {
                const itemsData = newOrderItems.map(item => ({
                    product_id: item.product_id,
                    quantity: item.quantity
                }));

                const addResponse = await fetch(`/api/v1/orders/${editingOrder.id}/add-items`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(itemsData)
                });

                if (!addResponse.ok) {
                    showError('Error agregando items');
                    return;
                }
            }

            showSuccess('Orden actualizada exitosamente');
            bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
            loadTables();
            updateStats();
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // ===== FUNCIONES PARA CONVERTIR A VENTA =====
    
    // Convertir orden a venta
    async function convertToSale() {
        if (!selectedOrderId) {
            showError('Debe seleccionar una orden');
            return;
        }

        if (confirm('¿Convertir esta orden en una venta? Esta acción no se puede deshacer.')) {
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('access_token');
                const response = await fetch(`/api/v1/orders/${selectedOrderId}/convert-to-sale`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const sale = await response.json();
                    showSuccess(`Orden convertida a venta exitosamente. Venta #${sale.sale_number}`);
                    bootstrap.Modal.getInstance(document.getElementById('tableOrdersModal')).hide();
                    loadTables();
                    updateStats();
                } else {
                    const error = await response.json();
                    showError(error.detail || 'Error convirtiendo a venta');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error de conexión');
            }
        }
    }

    // Convertir orden específica a venta (desde mis pedidos)
    async function convertOrderToSale(orderId) {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/orders/${orderId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const order = await response.json();
                
                // Llenar el modal de venta con los datos de la orden
                document.getElementById('sale-order-number').textContent = order.order_number;
                document.getElementById('sale-table-number').textContent = order.table ? order.table.table_number : 'N/A';
                document.getElementById('sale-customer-name').value = order.customer_name || '';
                document.getElementById('sale-payment-method').value = 'efectivo';
                document.getElementById('sale-notes').value = order.notes || '';
                
                // Calcular total
                const total = order.items.reduce((sum, item) => sum + parseFloat(item.subtotal), 0);
                document.getElementById('sale-total').textContent = `$${total.toFixed(2)}`;
                
                // Renderizar items de la venta
                const itemsContainer = document.getElementById('sale-items-list');
                itemsContainer.innerHTML = order.items.map(item => `
                    <div class="sale-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.quantity}x</strong> ${item.product ? item.product.name : 'Producto no encontrado'}
                                ${item.special_instructions ? `<br><small class="text-warning">${item.special_instructions}</small>` : ''}
                            </div>
                            <div class="text-end">
                                <strong>$${parseFloat(item.subtotal).toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Guardar el ID de la orden para la conversión
                document.getElementById('sale-order-id').value = orderId;
                
                // Mostrar modal de venta
                new bootstrap.Modal(document.getElementById('saleModal')).show();
            } else {
                showError('Error cargando orden');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // Función para formatear tiempo
    function formatTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleTimeString('es-ES', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }

    // Función de debug
    function debugInfo() {
        alert('Debug Info:\n' +
              'currentTables: ' + JSON.stringify(currentTables) + '\n' +
              'currentProducts: ' + JSON.stringify(currentProducts) + '\n' +
              'currentOrder: ' + JSON.stringify(currentOrder) + '\n' +
              'selectedTableId: ' + selectedTableId + '\n' +
              'selectedOrderId: ' + selectedOrderId + '\n' +
              'currentUser: ' + JSON.stringify(currentUser) + '\n' +
              'editingOrder: ' + JSON.stringify(editingOrder) + '\n' +
              'editingOrderItems: ' + JSON.stringify(editingOrderItems) + '\n' +
              'newOrderItems: ' + JSON.stringify(newOrderItems));
    }

    // Crear nuevo pedido desde botón de mesa
    function createNewOrder(tableId) {
        const table = currentTables.find(t => t.id === tableId);
        if (table) {
            selectedTableId = tableId;
            document.getElementById('modal-table-number').textContent = table.table_number;
            currentOrder = [];
            updateOrderSummary();
            updateProductQuantities();
            new bootstrap.Modal(document.getElementById('orderModal')).show();
        }
    }

    // Ver órdenes de mesa desde botón
    function viewTableOrders(tableId) {
        const table = currentTables.find(t => t.id === tableId);
        if (table) {
            selectedTableId = tableId;
            document.getElementById('modal-table-orders-number').textContent = table.table_number;
            loadTableOrders(tableId);
            new bootstrap.Modal(document.getElementById('tableOrdersModal')).show();
        }
    }

    // Servir órdenes listas desde botón
    async function serveOrders(tableId) {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/orders/?table_id=${tableId}&status=listo`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const orders = await response.json();
                let servedCount = 0;
                
                for (const order of orders) {
                    const serveResponse = await fetch(`/api/v1/orders/${order.id}/mark-served`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (serveResponse.ok) {
                        servedCount++;
                    }
                }
                
                if (servedCount > 0) {
                    showSuccess(`${servedCount} órdenes marcadas como servidas`);
                    loadTables();
                    updateStats();
                } else {
                    showError('No se pudieron marcar las órdenes como servidas');
                }
            } else {
                showError('Error cargando órdenes listas');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // Editar órdenes de mesa desde botón
    function editTableOrders(tableId) {
        const table = currentTables.find(t => t.id === tableId);
        if (table) {
            selectedTableId = tableId;
            document.getElementById('modal-table-orders-number').textContent = table.table_number;
            loadTableOrders(tableId);
            new bootstrap.Modal(document.getElementById('tableOrdersModal')).show();
        }
    }

    // Procesar venta
    async function processSale() {
        const orderId = document.getElementById('sale-order-id').value;
        const customerName = document.getElementById('sale-customer-name').value;
        const paymentMethod = document.getElementById('sale-payment-method').value;
        const notes = document.getElementById('sale-notes').value;

        if (!orderId) {
            showError('Error: No se encontró la orden');
            return;
        }

        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/orders/${orderId}/convert-to-sale`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    customer_name: customerName,
                    payment_method: paymentMethod,
                    notes: notes
                })
            });

            if (response.ok) {
                const sale = await response.json();
                showSuccess(`Venta procesada exitosamente. Venta #${sale.sale_number}`);
                
                // Cerrar modal y actualizar
                bootstrap.Modal.getInstance(document.getElementById('saleModal')).hide();
                loadTables();
                updateStats();
                
                // Si estaba en el modal de órdenes, cerrarlo también
                const tableOrdersModal = bootstrap.Modal.getInstance(document.getElementById('tableOrdersModal'));
                if (tableOrdersModal) {
                    tableOrdersModal.hide();
                }
            } else {
                const error = await response.json();
                showError(error.detail || 'Error procesando la venta');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }
</script>
{% endblock %}
