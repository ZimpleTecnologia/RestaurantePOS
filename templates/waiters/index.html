{% extends "base.html" %}

{% block title %}Panel de Meseros - Sistema POS{% endblock %}

{% block extra_css %}
<style>
    .table-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        padding: 20px;
    }
    
    .table-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        border: 3px solid transparent;
    }
    
    .table-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }
    
    .table-card.free {
        border-color: var(--accent-color);
    }
    
    .table-card.occupied {
        border-color: var(--warning-color);
        background-color: #fff8e1;
    }
    
    .table-card.reserved {
        border-color: var(--primary-color);
        background-color: #e3f2fd;
    }
    
    .table-card.maintenance {
        border-color: var(--danger-color);
        background-color: #ffebee;
    }
    
    .table-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .table-status {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-free {
        background-color: var(--accent-color);
        color: white;
    }
    
    .status-occupied {
        background-color: var(--warning-color);
        color: black;
    }
    
    .status-reserved {
        background-color: var(--primary-color);
        color: white;
    }
    
    .status-maintenance {
        background-color: var(--danger-color);
        color: white;
    }
    
    .order-modal .modal-content {
        border-radius: 15px;
    }
    
    .product-item {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        border-left: 4px solid var(--primary-color);
    }
    
    .product-item.selected {
        background-color: #e3f2fd;
        border-left-color: var(--accent-color);
    }
    
    .quantity-control {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .quantity-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: none;
        background-color: var(--primary-color);
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
    
    .quantity-btn:hover {
        background-color: var(--secondary-color);
    }
    
    .order-summary {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .kitchen-status {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .status-pendiente {
        background-color: var(--warning-color);
        color: black;
    }
    
    .status-en_preparacion {
        background-color: var(--primary-color);
        color: white;
    }
    
    .status-listo {
        background-color: var(--accent-color);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-person-badge"></i> Panel de Meseros</h2>
    <div>
        <button class="btn btn-primary" onclick="refreshTables()">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
        <button class="btn btn-success" onclick="viewKitchenOrders()">
            <i class="bi bi-fire"></i> Ver Cocina
        </button>
    </div>
</div>

<!-- Estadísticas rápidas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h4 id="total-tables">0</h4>
                <p class="mb-0">Total Mesas</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h4 id="occupied-tables">0</h4>
                <p class="mb-0">Ocupadas</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h4 id="pending-orders">0</h4>
                <p class="mb-0">Órdenes Pendientes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h4 id="ready-orders">0</h4>
                <p class="mb-0">Listas para Servir</p>
            </div>
        </div>
    </div>
</div>

<!-- Grid de Mesas -->
<div class="table-grid" id="tables-grid">
    <!-- Las mesas se cargarán dinámicamente aquí -->
</div>

<!-- Modal para Crear Orden -->
<div class="modal fade order-modal" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Nueva Orden - Mesa <span id="modal-table-number"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Productos Disponibles</h6>
                        <div id="products-list">
                            <!-- Los productos se cargarán aquí -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Orden Actual</h6>
                        <div class="order-summary" id="order-summary">
                            <p class="text-muted">No hay productos seleccionados</p>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Notas para la cocina:</label>
                            <textarea class="form-control" id="order-notes" rows="3" 
                                      placeholder="Instrucciones especiales..."></textarea>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Prioridad:</label>
                            <select class="form-select" id="order-priority">
                                <option value="normal">Normal</option>
                                <option value="alta">Alta</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitOrder()">
                    <i class="bi bi-check-circle"></i> Enviar a Cocina
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Órdenes de Mesa -->
<div class="modal fade" id="tableOrdersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-list-ul"></i> Órdenes de Mesa <span id="modal-table-orders-number"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="table-orders-list">
                    <!-- Las órdenes se cargarán aquí -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-success" onclick="markAsServed()">
                    <i class="bi bi-check-circle"></i> Marcar como Servido
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTables = [];
    let currentProducts = [];
    let currentOrder = [];
    let selectedTableId = null;
    let selectedOrderId = null;

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        loadTables();
        loadProducts();
        updateStats();
        
        // Auto-refresh cada 30 segundos
        setInterval(() => {
            loadTables();
            updateStats();
        }, 30000);
    });

    // Cargar mesas
    async function loadTables() {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch('/api/v1/tables/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                currentTables = await response.json();
                renderTables();
            } else {
                console.error('Error cargando mesas');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Cargar productos
    async function loadProducts() {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch('/api/v1/products/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                currentProducts = await response.json();
                renderProducts();
            } else {
                console.error('Error cargando productos');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Renderizar mesas
    function renderTables() {
        const grid = document.getElementById('tables-grid');
        grid.innerHTML = '';

        currentTables.forEach(table => {
            const tableCard = document.createElement('div');
            tableCard.className = `table-card ${table.status}`;
            tableCard.onclick = () => openTable(table);

            const statusClass = `status-${table.status}`;
            const statusText = getStatusText(table.status);

            tableCard.innerHTML = `
                <div class="table-number">${table.table_number}</div>
                <div class="table-status ${statusClass}">${statusText}</div>
                ${table.capacity ? `<div class="mt-2"><small>Capacidad: ${table.capacity}</small></div>` : ''}
                ${table.current_order ? `<div class="mt-2"><small>Orden: #${table.current_order}</small></div>` : ''}
            `;

            grid.appendChild(tableCard);
        });
    }

    // Renderizar productos
    function renderProducts() {
        const container = document.getElementById('products-list');
        container.innerHTML = '';

        currentProducts.forEach(product => {
            const productItem = document.createElement('div');
            productItem.className = 'product-item';
            productItem.onclick = () => selectProduct(product);

            productItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${product.name}</strong>
                        <br>
                        <small class="text-muted">${product.description || 'Sin descripción'}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold">$${product.price}</div>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="event.stopPropagation(); decreaseQuantity(${product.id})">-</button>
                            <span id="qty-${product.id}">0</span>
                            <button class="quantity-btn" onclick="event.stopPropagation(); increaseQuantity(${product.id})">+</button>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(productItem);
        });
    }

    // Abrir mesa
    function openTable(table) {
        if (table.status === 'free') {
            // Mesa libre - crear nueva orden
            selectedTableId = table.id;
            document.getElementById('modal-table-number').textContent = table.table_number;
            currentOrder = [];
            updateOrderSummary();
            new bootstrap.Modal(document.getElementById('orderModal')).show();
        } else if (table.status === 'occupied') {
            // Mesa ocupada - ver órdenes existentes
            selectedTableId = table.id;
            document.getElementById('modal-table-orders-number').textContent = table.table_number;
            loadTableOrders(table.id);
            new bootstrap.Modal(document.getElementById('tableOrdersModal')).show();
        }
    }

    // Seleccionar producto
    function selectProduct(product) {
        const existingItem = currentOrder.find(item => item.product_id === product.id);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            currentOrder.push({
                product_id: product.id,
                product_name: product.name,
                price: product.price,
                quantity: 1
            });
        }
        
        updateOrderSummary();
        updateProductQuantities();
    }

    // Aumentar cantidad
    function increaseQuantity(productId) {
        const existingItem = currentOrder.find(item => item.product_id === productId);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            const product = currentProducts.find(p => p.id === productId);
            if (product) {
                currentOrder.push({
                    product_id: product.id,
                    product_name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
        }
        
        updateOrderSummary();
        updateProductQuantities();
    }

    // Disminuir cantidad
    function decreaseQuantity(productId) {
        const existingItem = currentOrder.find(item => item.product_id === productId);
        
        if (existingItem) {
            existingItem.quantity -= 1;
            if (existingItem.quantity <= 0) {
                currentOrder = currentOrder.filter(item => item.product_id !== productId);
            }
        }
        
        updateOrderSummary();
        updateProductQuantities();
    }

    // Actualizar resumen de orden
    function updateOrderSummary() {
        const container = document.getElementById('order-summary');
        
        if (currentOrder.length === 0) {
            container.innerHTML = '<p class="text-muted">No hay productos seleccionados</p>';
            return;
        }

        let html = '';
        let total = 0;

        currentOrder.forEach(item => {
            const subtotal = item.price * item.quantity;
            total += subtotal;
            
            html += `
                <div class="order-item">
                    <div>
                        <strong>${item.product_name}</strong>
                        <br>
                        <small class="text-muted">$${item.price} x ${item.quantity}</small>
                    </div>
                    <div class="text-end">
                        <strong>$${subtotal.toFixed(2)}</strong>
                        <br>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromOrder(${item.product_id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        html += `
            <hr>
            <div class="order-item">
                <strong>Total:</strong>
                <strong>$${total.toFixed(2)}</strong>
            </div>
        `;

        container.innerHTML = html;
    }

    // Actualizar cantidades mostradas
    function updateProductQuantities() {
        currentOrder.forEach(item => {
            const qtyElement = document.getElementById(`qty-${item.product_id}`);
            if (qtyElement) {
                qtyElement.textContent = item.quantity;
            }
        });
    }

    // Remover de orden
    function removeFromOrder(productId) {
        currentOrder = currentOrder.filter(item => item.product_id !== productId);
        updateOrderSummary();
        updateProductQuantities();
    }

    // Enviar orden
    async function submitOrder() {
        if (currentOrder.length === 0) {
            alert('Debe seleccionar al menos un producto');
            return;
        }

        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const orderData = {
                table_id: selectedTableId,
                items: currentOrder.map(item => ({
                    product_id: item.product_id,
                    quantity: item.quantity
                })),
                notes: document.getElementById('order-notes').value,
                priority: document.getElementById('order-priority').value
            };

            const response = await fetch('/api/v1/orders/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                showSuccess('Orden enviada a cocina exitosamente');
                bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
                loadTables();
                updateStats();
            } else {
                const error = await response.json();
                showError(error.detail || 'Error enviando orden');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // Cargar órdenes de mesa
    async function loadTableOrders(tableId) {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/orders/?table_id=${tableId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const orders = await response.json();
                renderTableOrders(orders);
            } else {
                console.error('Error cargando órdenes de mesa');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Renderizar órdenes de mesa
    function renderTableOrders(orders) {
        const container = document.getElementById('table-orders-list');
        
        if (orders.length === 0) {
            container.innerHTML = '<p class="text-muted">No hay órdenes para esta mesa</p>';
            return;
        }

        let html = '';
        orders.forEach(order => {
            html += `
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Orden #${order.order_number}</strong>
                        <span class="kitchen-status status-${order.status}">${getStatusText(order.status)}</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Productos:</h6>
                                <ul class="list-unstyled">
                                    ${order.items.map(item => `
                                        <li>
                                            <strong>${item.quantity}x</strong> ${item.product ? item.product.name : 'Producto no encontrado'}
                                            ${item.special_instructions ? `<br><small class="text-warning">${item.special_instructions}</small>` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6>Información:</h6>
                                <p><strong>Prioridad:</strong> ${order.priority}</p>
                                <p><strong>Estado:</strong> ${getStatusText(order.status)}</p>
                                ${order.notes ? `<p><strong>Notas:</strong> ${order.notes}</p>` : ''}
                                ${order.kitchen_notes ? `<p><strong>Notas de cocina:</strong> ${order.kitchen_notes}</p>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Marcar como servido
    async function markAsServed() {
        if (!selectedOrderId) {
            showError('Debe seleccionar una orden');
            return;
        }

        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/orders/${selectedOrderId}/status`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ new_status: 'servido' })
            });

            if (response.ok) {
                showSuccess('Orden marcada como servida');
                bootstrap.Modal.getInstance(document.getElementById('tableOrdersModal')).hide();
                loadTables();
                updateStats();
            } else {
                const error = await response.json();
                showError(error.detail || 'Error marcando orden como servida');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Error de conexión');
        }
    }

    // Ver órdenes de cocina
    function viewKitchenOrders() {
        window.location.href = '/kitchen';
    }

    // Actualizar estadísticas
    async function updateStats() {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            
            // Estadísticas de mesas
            const tablesResponse = await fetch('/api/v1/tables/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (tablesResponse.ok) {
                const tables = await tablesResponse.json();
                document.getElementById('total-tables').textContent = tables.length;
                document.getElementById('occupied-tables').textContent = 
                    tables.filter(t => t.status === 'occupied').length;
            }

            // Estadísticas de órdenes
            const ordersResponse = await fetch('/api/v1/orders/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (ordersResponse.ok) {
                const orders = await ordersResponse.json();
                document.getElementById('pending-orders').textContent = 
                    orders.filter(o => o.status === 'pendiente').length;
                document.getElementById('ready-orders').textContent = 
                    orders.filter(o => o.status === 'listo').length;
            }
        } catch (error) {
            console.error('Error actualizando estadísticas:', error);
        }
    }

    // Refrescar mesas
    function refreshTables() {
        loadTables();
        updateStats();
    }

    // Utilidades
    function getStatusText(status) {
        const statusMap = {
            'free': 'Libre',
            'occupied': 'Ocupada',
            'reserved': 'Reservada',
            'maintenance': 'Mantenimiento',
            'pendiente': 'Pendiente',
            'en_preparacion': 'En Preparación',
            'listo': 'Listo',
            'servido': 'Servido'
        };
        return statusMap[status] || status;
    }

    function showSuccess(message) {
        // Implementar toast de éxito
        alert(message);
    }

    function showError(message) {
        // Implementar toast de error
        alert('Error: ' + message);
    }
</script>
{% endblock %}
